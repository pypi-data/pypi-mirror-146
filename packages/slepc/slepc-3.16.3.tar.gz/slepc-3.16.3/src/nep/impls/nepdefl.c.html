<center><a href="nepdefl.c">Actual source code: nepdefl.c</a></center><br>

<html>
<head> <link rel="canonical" href="https://slepc.upv.es/documentation/current/src/nep/impls/nepdefl.c.html" />
<title></title>
<meta name="generator" content="c2html 0.9.4">
<meta name="date" content="2022-04-11T09:36:33+00:00">
</head>

<body bgcolor="#FFFFFF">
   <div id="version" align=right><b>slepc-3.16.3 2022-04-11</b></div>
   <div id="bugreport" align=right><a href="mailto:slepc-maint@upv.es?subject=Typo or Error in Documentation &body=Please describe the typo or error in the documentation: slepc-3.16.3 v3.16.3 src/nep/impls/nepdefl.c.html "><small>Report Typos and Errors</small></a></div>
<pre width="80">
<a name="line1">  1: </a><font color="#B22222">/*</font>
<a name="line2">  2: </a><font color="#B22222">   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</font>
<a name="line3">  3: </a><font color="#B22222">   SLEPc - Scalable Library for Eigenvalue Problem Computations</font>
<a name="line4">  4: </a><font color="#B22222">   Copyright (c) 2002-2021, Universitat Politecnica de Valencia, Spain</font>

<a name="line6">  6: </a><font color="#B22222">   This file is part of SLEPc.</font>
<a name="line7">  7: </a><font color="#B22222">   SLEPc is distributed under a 2-clause BSD license (see LICENSE).</font>
<a name="line8">  8: </a><font color="#B22222">   - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</font>
<a name="line9">  9: </a><font color="#B22222">*/</font>

<a name="line11"> 11: </a>#include <A href="../../../include/slepc/private/nepimpl.h.html">&lt;slepc/private/nepimpl.h&gt;</A>
<a name="line12"> 12: </a>#include <A href="../../../include/slepcblaslapack.h.html">&lt;slepcblaslapack.h&gt;</A>
<a name="line13"> 13: </a><font color="#A020F0">#include </font><font color="#666666">"nepdefl.h"</font><font color="#A020F0"></font>

<a name="line15"> 15: </a><strong><font color="#4169E1"><a name="NEPDeflationGetInvariantPair"></a>PetscErrorCode NEPDeflationGetInvariantPair(NEP_EXT_OP extop,<a href="../../../docs/manualpages/sys/BV.html#BV">BV</a> *X,Mat *H)</font></strong>
<a name="line16"> 16: </a>{

<a name="line20"> 20: </a>  <font color="#4169E1">if</font> (X) *X = extop-&gt;X;
<a name="line21"> 21: </a>  <font color="#4169E1">if</font> (H) {
<a name="line22"> 22: </a>    MatCreateSeqDense(PETSC_COMM_SELF,extop-&gt;szd+1,extop-&gt;szd+1,extop-&gt;H,H);
<a name="line23"> 23: </a>  }
<a name="line24"> 24: </a>  <font color="#4169E1">return</font>(0);
<a name="line25"> 25: </a>}

<a name="line27"> 27: </a><strong><font color="#4169E1"><a name="NEPDeflationExtendInvariantPair"></a>PetscErrorCode NEPDeflationExtendInvariantPair(NEP_EXT_OP extop,Vec u,PetscScalar lambda,PetscInt k)</font></strong>
<a name="line28"> 28: </a>{
<a name="line30"> 30: </a>  Vec            uu;
<a name="line31"> 31: </a>  PetscInt       ld,i;
<a name="line32"> 32: </a>  PetscMPIInt    np;
<a name="line33"> 33: </a>  PetscReal      norm;

<a name="line36"> 36: </a>  <a href="../../../docs/manualpages/BV/BVGetColumn.html#BVGetColumn">BVGetColumn</a>(extop-&gt;X,k,&amp;uu);
<a name="line37"> 37: </a>  ld = extop-&gt;szd+1;
<a name="line38"> 38: </a>  NEPDeflationCopyToExtendedVec(extop,uu,extop-&gt;H+k*ld,u,PETSC_TRUE);
<a name="line39"> 39: </a>  <a href="../../../docs/manualpages/BV/BVRestoreColumn.html#BVRestoreColumn">BVRestoreColumn</a>(extop-&gt;X,k,&amp;uu);
<a name="line40"> 40: </a>  <a href="../../../docs/manualpages/BV/BVNormColumn.html#BVNormColumn">BVNormColumn</a>(extop-&gt;X,k,NORM_2,&amp;norm);
<a name="line41"> 41: </a>  <a href="../../../docs/manualpages/BV/BVScaleColumn.html#BVScaleColumn">BVScaleColumn</a>(extop-&gt;X,k,1.0/norm);
<a name="line42"> 42: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(PetscObjectComm((PetscObject)u),&amp;np);
<a name="line43"> 43: </a>  <font color="#4169E1">for</font> (i=0;i&lt;k;i++) extop-&gt;H[k*ld+i] *= PetscSqrtReal(np)/norm;
<a name="line44"> 44: </a>  extop-&gt;H[k*(ld+1)] = lambda;
<a name="line45"> 45: </a>  <font color="#4169E1">return</font>(0);
<a name="line46"> 46: </a>}

<a name="line48"> 48: </a><strong><font color="#4169E1"><a name="NEPDeflationExtractEigenpair"></a>PetscErrorCode NEPDeflationExtractEigenpair(NEP_EXT_OP extop,PetscInt k,Vec u,PetscScalar lambda,<a href="../../../docs/manualpages/sys/DS.html#DS">DS</a> ds)</font></strong>
<a name="line49"> 49: </a>{
<a name="line51"> 51: </a>  PetscScalar    *Ap;
<a name="line52"> 52: </a>  PetscInt       ldh=extop-&gt;szd+1,ldds,i,j,k1=k+1;
<a name="line53"> 53: </a>  PetscScalar    *eigr,*eigi,*t,*Z;
<a name="line54"> 54: </a>  Vec            x;

<a name="line57"> 57: </a>  NEPDeflationExtendInvariantPair(extop,u,lambda,k);
<a name="line58"> 58: </a>  PetscCalloc3(k1,&amp;eigr,k1,&amp;eigi,extop-&gt;szd,&amp;t);
<a name="line59"> 59: </a>  <a href="../../../docs/manualpages/DS/DSReset.html#DSReset">DSReset</a>(ds);
<a name="line60"> 60: </a>  <a href="../../../docs/manualpages/DS/DSSetType.html#DSSetType">DSSetType</a>(ds,<a href="../../../docs/manualpages/DS/DSNHEP.html#DSNHEP">DSNHEP</a>);
<a name="line61"> 61: </a>  <a href="../../../docs/manualpages/DS/DSAllocate.html#DSAllocate">DSAllocate</a>(ds,ldh);
<a name="line62"> 62: </a>  <a href="../../../docs/manualpages/DS/DSGetLeadingDimension.html#DSGetLeadingDimension">DSGetLeadingDimension</a>(ds,&amp;ldds);
<a name="line63"> 63: </a>  <a href="../../../docs/manualpages/DS/DSGetArray.html#DSGetArray">DSGetArray</a>(ds,<a href="../../../docs/manualpages/sys/DSMatType.html#DSMatType">DS_MAT_A</a>,&amp;Ap);
<a name="line64"> 64: </a>  <font color="#4169E1">for</font> (j=0;j&lt;k1;j++)
<a name="line65"> 65: </a>    <font color="#4169E1">for</font> (i=0;i&lt;k1;i++) Ap[j*ldds+i] = extop-&gt;H[j*ldh+i];
<a name="line66"> 66: </a>  <a href="../../../docs/manualpages/DS/DSRestoreArray.html#DSRestoreArray">DSRestoreArray</a>(ds,<a href="../../../docs/manualpages/sys/DSMatType.html#DSMatType">DS_MAT_A</a>,&amp;Ap);
<a name="line67"> 67: </a>  <a href="../../../docs/manualpages/DS/DSSetDimensions.html#DSSetDimensions">DSSetDimensions</a>(ds,k1,0,k1);
<a name="line68"> 68: </a>  <a href="../../../docs/manualpages/DS/DSSolve.html#DSSolve">DSSolve</a>(ds,eigr,eigi);
<a name="line69"> 69: </a>  <a href="../../../docs/manualpages/DS/DSVectors.html#DSVectors">DSVectors</a>(ds,<a href="../../../docs/manualpages/sys/DSMatType.html#DSMatType">DS_MAT_X</a>,&amp;k,NULL);
<a name="line70"> 70: </a>  <a href="../../../docs/manualpages/DS/DSGetArray.html#DSGetArray">DSGetArray</a>(ds,<a href="../../../docs/manualpages/sys/DSMatType.html#DSMatType">DS_MAT_X</a>,&amp;Z);
<a name="line71"> 71: </a>  <a href="../../../docs/manualpages/BV/BVMultColumn.html#BVMultColumn">BVMultColumn</a>(extop-&gt;X,1.0,Z[k*ldds+k],k,Z+k*ldds);
<a name="line72"> 72: </a>  <a href="../../../docs/manualpages/DS/DSRestoreArray.html#DSRestoreArray">DSRestoreArray</a>(ds,<a href="../../../docs/manualpages/sys/DSMatType.html#DSMatType">DS_MAT_X</a>,&amp;Z);
<a name="line73"> 73: </a>  <a href="../../../docs/manualpages/BV/BVGetColumn.html#BVGetColumn">BVGetColumn</a>(extop-&gt;X,k,&amp;x);
<a name="line74"> 74: </a>  NEPDeflationCopyToExtendedVec(extop,x,t,u,PETSC_FALSE);
<a name="line75"> 75: </a>  <a href="../../../docs/manualpages/BV/BVRestoreColumn.html#BVRestoreColumn">BVRestoreColumn</a>(extop-&gt;X,k,&amp;x);
<a name="line76"> 76: </a>  PetscFree3(eigr,eigi,t);
<a name="line77"> 77: </a>  <font color="#4169E1">return</font>(0);
<a name="line78"> 78: </a>}

<a name="line80"> 80: </a><strong><font color="#4169E1"><a name="NEPDeflationCopyToExtendedVec"></a>PetscErrorCode NEPDeflationCopyToExtendedVec(NEP_EXT_OP extop,Vec v,PetscScalar *a,Vec vex,PetscBool back)</font></strong>
<a name="line81"> 81: </a>{
<a name="line83"> 83: </a>  PetscMPIInt    np,rk,count;
<a name="line84"> 84: </a>  PetscScalar    *array1,*array2;
<a name="line85"> 85: </a>  PetscInt       nloc;

<a name="line88"> 88: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line89"> 89: </a>    <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_rank.html#MPI_Comm_rank">MPI_Comm_rank</a>(PetscObjectComm((PetscObject)vex),&amp;rk);
<a name="line90"> 90: </a>    <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(PetscObjectComm((PetscObject)vex),&amp;np);
<a name="line91"> 91: </a>    <a href="../../../docs/manualpages/BV/BVGetSizes.html#BVGetSizes">BVGetSizes</a>(extop-&gt;nep-&gt;V,&amp;nloc,NULL,NULL);
<a name="line92"> 92: </a>    <font color="#4169E1">if</font> (v) {
<a name="line93"> 93: </a>      VecGetArray(v,&amp;array1);
<a name="line94"> 94: </a>      VecGetArray(vex,&amp;array2);
<a name="line95"> 95: </a>      <font color="#4169E1">if</font> (back) {
<a name="line96"> 96: </a>        PetscArraycpy(array1,array2,nloc);
<a name="line97"> 97: </a>      } <font color="#4169E1">else</font> {
<a name="line98"> 98: </a>        PetscArraycpy(array2,array1,nloc);
<a name="line99"> 99: </a>      }
<a name="line100">100: </a>      VecRestoreArray(v,&amp;array1);
<a name="line101">101: </a>      VecRestoreArray(vex,&amp;array2);
<a name="line102">102: </a>    }
<a name="line103">103: </a>    <font color="#4169E1">if</font> (a) {
<a name="line104">104: </a>      VecGetArray(vex,&amp;array2);
<a name="line105">105: </a>      <font color="#4169E1">if</font> (back) {
<a name="line106">106: </a>        PetscArraycpy(a,array2+nloc,extop-&gt;szd);
<a name="line107">107: </a>        PetscMPIIntCast(extop-&gt;szd,&amp;count);
<a name="line108">108: </a>        <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Bcast.html#MPI_Bcast">MPI_Bcast</a>(a,count,MPIU_SCALAR,np-1,PetscObjectComm((PetscObject)vex));
<a name="line109">109: </a>      } <font color="#4169E1">else</font> {
<a name="line110">110: </a>        PetscArraycpy(array2+nloc,a,extop-&gt;szd);
<a name="line111">111: </a>        PetscMPIIntCast(extop-&gt;szd,&amp;count);
<a name="line112">112: </a>        <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Bcast.html#MPI_Bcast">MPI_Bcast</a>(array2+nloc,count,MPIU_SCALAR,np-1,PetscObjectComm((PetscObject)vex));
<a name="line113">113: </a>      }
<a name="line114">114: </a>      VecRestoreArray(vex,&amp;array2);
<a name="line115">115: </a>    }
<a name="line116">116: </a>  } <font color="#4169E1">else</font> {
<a name="line117">117: </a>    <font color="#4169E1">if</font> (back) {VecCopy(vex,v);}
<a name="line118">118: </a>    <font color="#4169E1">else</font> {VecCopy(v,vex);}
<a name="line119">119: </a>  }
<a name="line120">120: </a>  <font color="#4169E1">return</font>(0);
<a name="line121">121: </a>}

<a name="line123">123: </a><strong><font color="#4169E1"><a name="NEPDeflationCreateVec"></a>PetscErrorCode NEPDeflationCreateVec(NEP_EXT_OP extop,Vec *v)</font></strong>
<a name="line124">124: </a>{
<a name="line126">126: </a>  PetscInt       nloc;
<a name="line127">127: </a>  Vec            u;
<a name="line128">128: </a>  VecType        type;

<a name="line131">131: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line132">132: </a>    <a href="../../../docs/manualpages/BV/BVGetColumn.html#BVGetColumn">BVGetColumn</a>(extop-&gt;nep-&gt;V,0,&amp;u);
<a name="line133">133: </a>    VecGetType(u,&amp;type);
<a name="line134">134: </a>    <a href="../../../docs/manualpages/BV/BVRestoreColumn.html#BVRestoreColumn">BVRestoreColumn</a>(extop-&gt;nep-&gt;V,0,&amp;u);
<a name="line135">135: </a>    VecCreate(PetscObjectComm((PetscObject)extop-&gt;nep),v);
<a name="line136">136: </a>    VecSetType(*v,type);
<a name="line137">137: </a>    <a href="../../../docs/manualpages/BV/BVGetSizes.html#BVGetSizes">BVGetSizes</a>(extop-&gt;nep-&gt;V,&amp;nloc,NULL,NULL);
<a name="line138">138: </a>    nloc += extop-&gt;szd;
<a name="line139">139: </a>    VecSetSizes(*v,nloc,PETSC_DECIDE);
<a name="line140">140: </a>  } <font color="#4169E1">else</font> {
<a name="line141">141: </a>    <a href="../../../docs/manualpages/BV/BVCreateVec.html#BVCreateVec">BVCreateVec</a>(extop-&gt;nep-&gt;V,v);
<a name="line142">142: </a>  }
<a name="line143">143: </a>  <font color="#4169E1">return</font>(0);
<a name="line144">144: </a>}

<a name="line146">146: </a><strong><font color="#4169E1"><a name="NEPDeflationCreateBV"></a>PetscErrorCode NEPDeflationCreateBV(NEP_EXT_OP extop,PetscInt sz,<a href="../../../docs/manualpages/sys/BV.html#BV">BV</a> *V)</font></strong>
<a name="line147">147: </a>{
<a name="line148">148: </a>  PetscErrorCode     ierr;
<a name="line149">149: </a>  PetscInt           nloc;
<a name="line150">150: </a>  <a href="../../../docs/manualpages/sys/BVType.html#BVType">BVType</a>             type;
<a name="line151">151: </a>  <a href="../../../docs/manualpages/sys/BVOrthogType.html#BVOrthogType">BVOrthogType</a>       otype;
<a name="line152">152: </a>  <a href="../../../docs/manualpages/sys/BVOrthogRefineType.html#BVOrthogRefineType">BVOrthogRefineType</a> oref;
<a name="line153">153: </a>  PetscReal          oeta;
<a name="line154">154: </a>  <a href="../../../docs/manualpages/sys/BVOrthogBlockType.html#BVOrthogBlockType">BVOrthogBlockType</a>  oblock;
<a name="line155">155: </a>  <a href="../../../docs/manualpages/sys/NEP.html#NEP">NEP</a>                nep=extop-&gt;nep;

<a name="line158">158: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line159">159: </a>    <a href="../../../docs/manualpages/BV/BVGetSizes.html#BVGetSizes">BVGetSizes</a>(nep-&gt;V,&amp;nloc,NULL,NULL);
<a name="line160">160: </a>    <a href="../../../docs/manualpages/BV/BVCreate.html#BVCreate">BVCreate</a>(PetscObjectComm((PetscObject)nep),V);
<a name="line161">161: </a>    <a href="../../../docs/manualpages/BV/BVSetSizes.html#BVSetSizes">BVSetSizes</a>(*V,nloc+extop-&gt;szd,PETSC_DECIDE,sz);
<a name="line162">162: </a>    <a href="../../../docs/manualpages/BV/BVGetType.html#BVGetType">BVGetType</a>(nep-&gt;V,&amp;type);
<a name="line163">163: </a>    <a href="../../../docs/manualpages/BV/BVSetType.html#BVSetType">BVSetType</a>(*V,type);
<a name="line164">164: </a>    <a href="../../../docs/manualpages/BV/BVGetOrthogonalization.html#BVGetOrthogonalization">BVGetOrthogonalization</a>(nep-&gt;V,&amp;otype,&amp;oref,&amp;oeta,&amp;oblock);
<a name="line165">165: </a>    <a href="../../../docs/manualpages/BV/BVSetOrthogonalization.html#BVSetOrthogonalization">BVSetOrthogonalization</a>(*V,otype,oref,oeta,oblock);
<a name="line166">166: </a>    PetscObjectStateIncrease((PetscObject)*V);
<a name="line167">167: </a>    PetscLogObjectParent((PetscObject)nep,(PetscObject)*V);
<a name="line168">168: </a>  } <font color="#4169E1">else</font> {
<a name="line169">169: </a>    <a href="../../../docs/manualpages/BV/BVDuplicateResize.html#BVDuplicateResize">BVDuplicateResize</a>(nep-&gt;V,sz,V);
<a name="line170">170: </a>  }
<a name="line171">171: </a>  <font color="#4169E1">return</font>(0);
<a name="line172">172: </a>}

<a name="line174">174: </a><strong><font color="#4169E1"><a name="NEPDeflationSetRandomVec"></a>PetscErrorCode NEPDeflationSetRandomVec(NEP_EXT_OP extop,Vec v)</font></strong>
<a name="line175">175: </a>{
<a name="line177">177: </a>  PetscInt       n,next,i;
<a name="line178">178: </a>  PetscRandom    rand;
<a name="line179">179: </a>  PetscScalar    *array;
<a name="line180">180: </a>  PetscMPIInt    nn,np;

<a name="line183">183: </a>  <a href="../../../docs/manualpages/BV/BVGetRandomContext.html#BVGetRandomContext">BVGetRandomContext</a>(extop-&gt;nep-&gt;V,&amp;rand);
<a name="line184">184: </a>  VecSetRandom(v,rand);
<a name="line185">185: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line186">186: </a>    <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(PetscObjectComm((PetscObject)v),&amp;np);
<a name="line187">187: </a>    <a href="../../../docs/manualpages/BV/BVGetSizes.html#BVGetSizes">BVGetSizes</a>(extop-&gt;nep-&gt;V,&amp;n,NULL,NULL);
<a name="line188">188: </a>    VecGetLocalSize(v,&amp;next);
<a name="line189">189: </a>    VecGetArray(v,&amp;array);
<a name="line190">190: </a>    <font color="#4169E1">for</font> (i=n+extop-&gt;n;i&lt;next;i++) array[i] = 0.0;
<a name="line191">191: </a>    <font color="#4169E1">for</font> (i=n;i&lt;n+extop-&gt;n;i++) array[i] /= PetscSqrtReal(np);
<a name="line192">192: </a>    PetscMPIIntCast(extop-&gt;n,&amp;nn);
<a name="line193">193: </a>    <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Bcast.html#MPI_Bcast">MPI_Bcast</a>(array+n,nn,MPIU_SCALAR,0,PetscObjectComm((PetscObject)v));
<a name="line194">194: </a>    VecRestoreArray(v,&amp;array);
<a name="line195">195: </a>  }
<a name="line196">196: </a>  <font color="#4169E1">return</font>(0);
<a name="line197">197: </a>}

<a name="line199">199: </a><strong><font color="#4169E1"><a name="NEPDeflationEvaluateBasisMat"></a>static PetscErrorCode NEPDeflationEvaluateBasisMat(NEP_EXT_OP extop,PetscInt idx,PetscBool hat,PetscScalar *bval,PetscScalar *Hj,PetscScalar *Hjprev)</font></strong>
<a name="line200">200: </a>{
<a name="line202">202: </a>  PetscInt       i,k,n=extop-&gt;n,ldhj=extop-&gt;szd,ldh=extop-&gt;szd+1;
<a name="line203">203: </a>  PetscScalar    sone=1.0,zero=0.0;
<a name="line204">204: </a>  PetscBLASInt   ldh_,ldhj_,n_;

<a name="line207">207: </a>  i = (idx&lt;0)?extop-&gt;szd*extop-&gt;szd*(-idx):extop-&gt;szd*extop-&gt;szd;
<a name="line208">208: </a>  PetscArrayzero(Hj,i);
<a name="line209">209: </a>  PetscBLASIntCast(ldhj+1,&amp;ldh_);
<a name="line210">210: </a>  PetscBLASIntCast(ldhj,&amp;ldhj_);
<a name="line211">211: </a>  PetscBLASIntCast(n,&amp;n_);
<a name="line212">212: </a>  <font color="#4169E1">if</font> (idx&lt;1) {
<a name="line213">213: </a>    <font color="#4169E1">if</font> (!hat) <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) Hj[i+i*ldhj] = 1.0;
<a name="line214">214: </a>    <font color="#4169E1">else</font> <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) Hj[i+i*ldhj] = 0.0;
<a name="line215">215: </a>  } <font color="#4169E1">else</font> {
<a name="line216">216: </a>      <font color="#4169E1">for</font> (i=0;i&lt;n;i++) extop-&gt;H[i*ldh+i] -= extop-&gt;bc[idx-1];
<a name="line217">217: </a>      PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;n_,&amp;sone,extop-&gt;H,&amp;ldh_,Hjprev,&amp;ldhj_,&amp;zero,Hj,&amp;ldhj_));
<a name="line218">218: </a>      <font color="#4169E1">for</font> (i=0;i&lt;n;i++) extop-&gt;H[i*ldh+i] += extop-&gt;bc[idx-1];
<a name="line219">219: </a>      <font color="#4169E1">if</font> (hat) <font color="#4169E1">for</font> (i=0;i&lt;n;i++) Hj[i*(ldhj+1)] += bval[idx-1];
<a name="line220">220: </a>  }
<a name="line221">221: </a>  <font color="#4169E1">if</font> (idx&lt;0) {
<a name="line222">222: </a>    idx = -idx;
<a name="line223">223: </a>    <font color="#4169E1">for</font> (k=1;k&lt;idx;k++) {
<a name="line224">224: </a>      <font color="#4169E1">for</font> (i=0;i&lt;n;i++) extop-&gt;H[i*ldh+i] -= extop-&gt;bc[k-1];
<a name="line225">225: </a>      PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;n_,&amp;sone,extop-&gt;H,&amp;ldh_,Hj+(k-1)*ldhj*ldhj,&amp;ldhj_,&amp;zero,Hj+k*ldhj*ldhj,&amp;ldhj_));
<a name="line226">226: </a>      <font color="#4169E1">for</font> (i=0;i&lt;n;i++) extop-&gt;H[i*ldh+i] += extop-&gt;bc[k-1];
<a name="line227">227: </a>      <font color="#4169E1">if</font> (hat) <font color="#4169E1">for</font> (i=0;i&lt;n;i++) Hj[i*(ldhj+1)] += bval[k-1];
<a name="line228">228: </a>    }
<a name="line229">229: </a>  }
<a name="line230">230: </a>  <font color="#4169E1">return</font>(0);
<a name="line231">231: </a>}

<a name="line233">233: </a><strong><font color="#4169E1"><a name="NEPDeflationLocking"></a>PetscErrorCode NEPDeflationLocking(NEP_EXT_OP extop,Vec u,PetscScalar lambda)</font></strong>
<a name="line234">234: </a>{
<a name="line236">236: </a>  PetscInt       i;

<a name="line239">239: </a>  NEPDeflationExtendInvariantPair(extop,u,lambda,extop-&gt;n);
<a name="line240">240: </a>  extop-&gt;n++;
<a name="line241">241: </a>  <a href="../../../docs/manualpages/BV/BVSetActiveColumns.html#BVSetActiveColumns">BVSetActiveColumns</a>(extop-&gt;X,0,extop-&gt;n);
<a name="line242">242: </a>  <font color="#4169E1">if</font> (extop-&gt;n &lt;= extop-&gt;szd) {
<a name="line243">243: </a>    <font color="#B22222">/* update XpX */</font>
<a name="line244">244: </a>    <a href="../../../docs/manualpages/BV/BVDotColumn.html#BVDotColumn">BVDotColumn</a>(extop-&gt;X,extop-&gt;n-1,extop-&gt;XpX+(extop-&gt;n-1)*extop-&gt;szd);
<a name="line245">245: </a>    extop-&gt;XpX[(extop-&gt;n-1)*(1+extop-&gt;szd)] = 1.0;
<a name="line246">246: </a>    <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n-1;i++) extop-&gt;XpX[i*extop-&gt;szd+extop-&gt;n-1] = PetscConj(extop-&gt;XpX[(extop-&gt;n-1)*extop-&gt;szd+i]);
<a name="line247">247: </a>    <font color="#B22222">/* determine minimality index */</font>
<a name="line248">248: </a>    extop-&gt;midx = PetscMin(extop-&gt;max_midx,extop-&gt;n);
<a name="line249">249: </a>    <font color="#B22222">/* polynominal basis coefficients */</font>
<a name="line250">250: </a>    <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;midx;i++) extop-&gt;bc[i] = extop-&gt;nep-&gt;target;
<a name="line251">251: </a>    <font color="#B22222">/* evaluate the polynomial basis in H */</font>
<a name="line252">252: </a>    NEPDeflationEvaluateBasisMat(extop,-extop-&gt;midx,PETSC_FALSE,NULL,extop-&gt;Hj,NULL);
<a name="line253">253: </a>  }
<a name="line254">254: </a>  <font color="#4169E1">return</font>(0);
<a name="line255">255: </a>}

<a name="line257">257: </a><strong><font color="#4169E1"><a name="NEPDeflationEvaluateHatFunction"></a>static PetscErrorCode NEPDeflationEvaluateHatFunction(NEP_EXT_OP extop, PetscInt idx,PetscScalar lambda,PetscScalar *y,PetscScalar *hfj,PetscScalar *hfjp,PetscInt ld)</font></strong>
<a name="line258">258: </a>{
<a name="line259">259: </a>  PetscErrorCode    ierr;
<a name="line260">260: </a>  PetscInt          i,j,k,off,ini,fin,sz,ldh,n=extop-&gt;n;
<a name="line261">261: </a>  Mat               A,B;
<a name="line262">262: </a>  PetscScalar       *array;
<a name="line263">263: </a>  const PetscScalar *barray;

<a name="line266">266: </a>  <font color="#4169E1">if</font> (idx&lt;0) {ini = 0; fin = extop-&gt;nep-&gt;nt;}
<a name="line267">267: </a>  <font color="#4169E1">else</font> {ini = idx; fin = idx+1;}
<a name="line268">268: </a>  <font color="#4169E1">if</font> (y) sz = hfjp?n+2:n+1;
<a name="line269">269: </a>  <font color="#4169E1">else</font> sz = hfjp?3*n:2*n;
<a name="line270">270: </a>  ldh = extop-&gt;szd+1;
<a name="line271">271: </a>  MatCreateSeqDense(PETSC_COMM_SELF,sz,sz,NULL,&amp;A);
<a name="line272">272: </a>  MatCreateSeqDense(PETSC_COMM_SELF,sz,sz,NULL,&amp;B);
<a name="line273">273: </a>  MatDenseGetArray(A,&amp;array);
<a name="line274">274: </a>  <font color="#4169E1">for</font> (j=0;j&lt;n;j++)
<a name="line275">275: </a>    <font color="#4169E1">for</font> (i=0;i&lt;n;i++) array[j*sz+i] = extop-&gt;H[j*ldh+i];
<a name="line276">276: </a>  MatDenseRestoreArrayWrite(A,&amp;array);
<a name="line277">277: </a>  <font color="#4169E1">if</font> (y) {
<a name="line278">278: </a>    MatDenseGetArray(A,&amp;array);
<a name="line279">279: </a>    array[extop-&gt;n*(sz+1)] = lambda;
<a name="line280">280: </a>    <font color="#4169E1">if</font> (hfjp) { array[(n+1)*sz+n] = 1.0; array[(n+1)*sz+n+1] = lambda;}
<a name="line281">281: </a>    <font color="#4169E1">for</font> (i=0;i&lt;n;i++) array[n*sz+i] = y[i];
<a name="line282">282: </a>    MatDenseRestoreArrayWrite(A,&amp;array);
<a name="line283">283: </a>    <font color="#4169E1">for</font> (j=ini;j&lt;fin;j++) {
<a name="line284">284: </a>      <a href="../../../docs/manualpages/FN/FNEvaluateFunctionMat.html#FNEvaluateFunctionMat">FNEvaluateFunctionMat</a>(extop-&gt;nep-&gt;f[j],A,B);
<a name="line285">285: </a>      MatDenseGetArrayRead(B,&amp;barray);
<a name="line286">286: </a>      <font color="#4169E1">for</font> (i=0;i&lt;n;i++) hfj[j*ld+i] = barray[n*sz+i];
<a name="line287">287: </a>      <font color="#4169E1">if</font> (hfjp) <font color="#4169E1">for</font> (i=0;i&lt;n;i++) hfjp[j*ld+i] = barray[(n+1)*sz+i];
<a name="line288">288: </a>      MatDenseRestoreArrayRead(B,&amp;barray);
<a name="line289">289: </a>    }
<a name="line290">290: </a>  } <font color="#4169E1">else</font> {
<a name="line291">291: </a>    off = idx&lt;0?ld*n:0;
<a name="line292">292: </a>    MatDenseGetArray(A,&amp;array);
<a name="line293">293: </a>    <font color="#4169E1">for</font> (k=0;k&lt;n;k++) {
<a name="line294">294: </a>      array[(n+k)*sz+k] = 1.0;
<a name="line295">295: </a>      array[(n+k)*sz+n+k] = lambda;
<a name="line296">296: </a>    }
<a name="line297">297: </a>    <font color="#4169E1">if</font> (hfjp) <font color="#4169E1">for</font> (k=0;k&lt;n;k++) {
<a name="line298">298: </a>      array[(2*n+k)*sz+n+k] = 1.0;
<a name="line299">299: </a>      array[(2*n+k)*sz+2*n+k] = lambda;
<a name="line300">300: </a>    }
<a name="line301">301: </a>    MatDenseRestoreArray(A,&amp;array);
<a name="line302">302: </a>    <font color="#4169E1">for</font> (j=ini;j&lt;fin;j++) {
<a name="line303">303: </a>      <a href="../../../docs/manualpages/FN/FNEvaluateFunctionMat.html#FNEvaluateFunctionMat">FNEvaluateFunctionMat</a>(extop-&gt;nep-&gt;f[j],A,B);
<a name="line304">304: </a>      MatDenseGetArrayRead(B,&amp;barray);
<a name="line305">305: </a>      <font color="#4169E1">for</font> (i=0;i&lt;n;i++) <font color="#4169E1">for</font> (k=0;k&lt;n;k++) hfj[j*off+i*ld+k] = barray[n*sz+i*sz+k];
<a name="line306">306: </a>      <font color="#4169E1">if</font> (hfjp) <font color="#4169E1">for</font> (k=0;k&lt;n;k++) <font color="#4169E1">for</font> (i=0;i&lt;n;i++) hfjp[j*off+i*ld+k] = barray[2*n*sz+i*sz+k];
<a name="line307">307: </a>      MatDenseRestoreArrayRead(B,&amp;barray);
<a name="line308">308: </a>    }
<a name="line309">309: </a>  }
<a name="line310">310: </a>  MatDestroy(&amp;A);
<a name="line311">311: </a>  MatDestroy(&amp;B);
<a name="line312">312: </a>  <font color="#4169E1">return</font>(0);
<a name="line313">313: </a>}

<a name="line315">315: </a><strong><font color="#4169E1"><a name="MatMult_NEPDeflation"></a>static PetscErrorCode MatMult_NEPDeflation(Mat M,Vec x,Vec y)</font></strong>
<a name="line316">316: </a>{
<a name="line317">317: </a>  NEP_DEF_MATSHELL  *matctx;
<a name="line318">318: </a>  PetscErrorCode    ierr;
<a name="line319">319: </a>  NEP_EXT_OP        extop;
<a name="line320">320: </a>  Vec               x1,y1;
<a name="line321">321: </a>  PetscScalar       *yy,sone=1.0,zero=0.0;
<a name="line322">322: </a>  const PetscScalar *xx;
<a name="line323">323: </a>  PetscInt          nloc,i;
<a name="line324">324: </a>  PetscMPIInt       np;
<a name="line325">325: </a>  PetscBLASInt      n_,one=1,szd_;

<a name="line328">328: </a>  <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(PetscObjectComm((PetscObject)M),&amp;np);
<a name="line329">329: </a>  MatShellGetContext(M,&amp;matctx);
<a name="line330">330: </a>  extop = matctx-&gt;extop;
<a name="line331">331: </a>  <font color="#4169E1">if</font> (extop-&gt;ref) {
<a name="line332">332: </a>    VecZeroEntries(y);
<a name="line333">333: </a>  }
<a name="line334">334: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line335">335: </a>    x1 = matctx-&gt;w[0]; y1 = matctx-&gt;w[1];
<a name="line336">336: </a>    VecGetArrayRead(x,&amp;xx);
<a name="line337">337: </a>    VecPlaceArray(x1,xx);
<a name="line338">338: </a>    VecGetArray(y,&amp;yy);
<a name="line339">339: </a>    VecPlaceArray(y1,yy);
<a name="line340">340: </a>    MatMult(matctx-&gt;T,x1,y1);
<a name="line341">341: </a>    <font color="#4169E1">if</font> (!extop-&gt;ref &amp;&amp; extop-&gt;n) {
<a name="line342">342: </a>      VecGetLocalSize(x1,&amp;nloc);
<a name="line343">343: </a>      <font color="#B22222">/* copy for avoiding warning of constant array xx */</font>
<a name="line344">344: </a>      <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) matctx-&gt;work[i] = xx[nloc+i]*PetscSqrtReal(np);
<a name="line345">345: </a>      <a href="../../../docs/manualpages/BV/BVMultVec.html#BVMultVec">BVMultVec</a>(matctx-&gt;U,1.0,1.0,y1,matctx-&gt;work);
<a name="line346">346: </a>      <a href="../../../docs/manualpages/BV/BVDotVec.html#BVDotVec">BVDotVec</a>(extop-&gt;X,x1,matctx-&gt;work);
<a name="line347">347: </a>      PetscBLASIntCast(extop-&gt;n,&amp;n_);
<a name="line348">348: </a>      PetscBLASIntCast(extop-&gt;szd,&amp;szd_);
<a name="line349">349: </a>      PetscStackCallBLAS(<font color="#666666">"BLASgemv"</font>,BLASgemv_(<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;sone,matctx-&gt;A,&amp;szd_,matctx-&gt;work,&amp;one,&amp;zero,yy+nloc,&amp;one));
<a name="line350">350: </a>      PetscStackCallBLAS(<font color="#666666">"BLASgemv"</font>,BLASgemv_(<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;sone,matctx-&gt;B,&amp;szd_,xx+nloc,&amp;one,&amp;sone,yy+nloc,&amp;one));
<a name="line351">351: </a>      <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) yy[nloc+i] /= PetscSqrtReal(np);
<a name="line352">352: </a>    }
<a name="line353">353: </a>    VecResetArray(x1);
<a name="line354">354: </a>    VecRestoreArrayRead(x,&amp;xx);
<a name="line355">355: </a>    VecResetArray(y1);
<a name="line356">356: </a>    VecRestoreArray(y,&amp;yy);
<a name="line357">357: </a>  } <font color="#4169E1">else</font> {
<a name="line358">358: </a>    MatMult(matctx-&gt;T,x,y);
<a name="line359">359: </a>  }
<a name="line360">360: </a>  <font color="#4169E1">return</font>(0);
<a name="line361">361: </a>}

<a name="line363">363: </a><strong><font color="#4169E1"><a name="MatCreateVecs_NEPDeflation"></a>static PetscErrorCode MatCreateVecs_NEPDeflation(Mat M,Vec *right,Vec *left)</font></strong>
<a name="line364">364: </a>{
<a name="line365">365: </a>  PetscErrorCode   ierr;
<a name="line366">366: </a>  NEP_DEF_MATSHELL *matctx;

<a name="line369">369: </a>  MatShellGetContext(M,&amp;matctx);
<a name="line370">370: </a>  <font color="#4169E1">if</font> (right) {
<a name="line371">371: </a>    VecDuplicate(matctx-&gt;w[0],right);
<a name="line372">372: </a>  }
<a name="line373">373: </a>  <font color="#4169E1">if</font> (left) {
<a name="line374">374: </a>    VecDuplicate(matctx-&gt;w[0],left);
<a name="line375">375: </a>  }
<a name="line376">376: </a>  <font color="#4169E1">return</font>(0);
<a name="line377">377: </a>}

<a name="line379">379: </a><strong><font color="#4169E1"><a name="MatDestroy_NEPDeflation"></a>static PetscErrorCode MatDestroy_NEPDeflation(Mat M)</font></strong>
<a name="line380">380: </a>{
<a name="line381">381: </a>  PetscErrorCode   ierr;
<a name="line382">382: </a>  NEP_DEF_MATSHELL *matctx;

<a name="line385">385: </a>  MatShellGetContext(M,&amp;matctx);
<a name="line386">386: </a>  <font color="#4169E1">if</font> (matctx-&gt;extop-&gt;szd) {
<a name="line387">387: </a>    <a href="../../../docs/manualpages/BV/BVDestroy.html#BVDestroy">BVDestroy</a>(&amp;matctx-&gt;U);
<a name="line388">388: </a>    PetscFree2(matctx-&gt;hfj,matctx-&gt;work);
<a name="line389">389: </a>    PetscFree2(matctx-&gt;A,matctx-&gt;B);
<a name="line390">390: </a>    VecDestroy(&amp;matctx-&gt;w[0]);
<a name="line391">391: </a>    VecDestroy(&amp;matctx-&gt;w[1]);
<a name="line392">392: </a>  }
<a name="line393">393: </a>  MatDestroy(&amp;matctx-&gt;T);
<a name="line394">394: </a>  PetscFree(matctx);
<a name="line395">395: </a>  <font color="#4169E1">return</font>(0);
<a name="line396">396: </a>}

<a name="line398">398: </a><strong><font color="#4169E1"><a name="NEPDeflationEvaluateBasis"></a>static PetscErrorCode NEPDeflationEvaluateBasis(NEP_EXT_OP extop,PetscScalar lambda,PetscInt n,PetscScalar *val,PetscBool jacobian)</font></strong>
<a name="line399">399: </a>{
<a name="line400">400: </a>  PetscScalar p;
<a name="line401">401: </a>  PetscInt    i;

<a name="line404">404: </a>  <font color="#4169E1">if</font> (!jacobian) {
<a name="line405">405: </a>    val[0] = 1.0;
<a name="line406">406: </a>    <font color="#4169E1">for</font> (i=1;i&lt;extop-&gt;n;i++) val[i] = val[i-1]*(lambda-extop-&gt;bc[i-1]);
<a name="line407">407: </a>  } <font color="#4169E1">else</font> {
<a name="line408">408: </a>    val[0] = 0.0;
<a name="line409">409: </a>    p = 1.0;
<a name="line410">410: </a>    <font color="#4169E1">for</font> (i=1;i&lt;extop-&gt;n;i++) {
<a name="line411">411: </a>      val[i] = val[i-1]*(lambda-extop-&gt;bc[i-1])+p;
<a name="line412">412: </a>      p *= (lambda-extop-&gt;bc[i-1]);
<a name="line413">413: </a>    }
<a name="line414">414: </a>  }
<a name="line415">415: </a>  <font color="#4169E1">return</font>(0);
<a name="line416">416: </a>}

<a name="line418">418: </a><strong><font color="#4169E1"><a name="NEPDeflationComputeShellMat"></a>static PetscErrorCode NEPDeflationComputeShellMat(NEP_EXT_OP extop,PetscScalar lambda,PetscBool jacobian,Mat *M)</font></strong>
<a name="line419">419: </a>{
<a name="line420">420: </a>  PetscErrorCode   ierr;
<a name="line421">421: </a>  NEP_DEF_MATSHELL *matctx,*matctxC;
<a name="line422">422: </a>  PetscInt         nloc,mloc,n=extop-&gt;n,j,i,szd=extop-&gt;szd,ldh=szd+1,k;
<a name="line423">423: </a>  Mat              F,Mshell,Mcomp;
<a name="line424">424: </a>  PetscBool        ini=PETSC_FALSE;
<a name="line425">425: </a>  PetscScalar      *hf,*hfj,*hfjp,sone=1.0,*hH,*hHprev,*pts,*B,*A,*Hj=extop-&gt;Hj,*basisv,zero=0.0;
<a name="line426">426: </a>  PetscBLASInt     n_,info,szd_;

<a name="line429">429: </a>  <font color="#4169E1">if</font> (!M) Mshell = jacobian?extop-&gt;MJ:extop-&gt;MF;
<a name="line430">430: </a>  <font color="#4169E1">else</font> Mshell = *M;
<a name="line431">431: </a>  Mcomp = jacobian?extop-&gt;MF:extop-&gt;MJ;
<a name="line432">432: </a>  <font color="#4169E1">if</font> (!Mshell) {
<a name="line433">433: </a>    ini = PETSC_TRUE;
<a name="line434">434: </a>    PetscNew(&amp;matctx);
<a name="line435">435: </a>    MatGetLocalSize(extop-&gt;nep-&gt;function,&amp;mloc,&amp;nloc);
<a name="line436">436: </a>    nloc += szd; mloc += szd;
<a name="line437">437: </a>    MatCreateShell(PetscObjectComm((PetscObject)extop-&gt;nep),nloc,mloc,PETSC_DETERMINE,PETSC_DETERMINE,matctx,&amp;Mshell);
<a name="line438">438: </a>    MatShellSetOperation(Mshell,MATOP_MULT,(void(*)(void))MatMult_NEPDeflation);
<a name="line439">439: </a>    MatShellSetOperation(Mshell,MATOP_CREATE_VECS,(void(*)(void))MatCreateVecs_NEPDeflation);
<a name="line440">440: </a>    MatShellSetOperation(Mshell,MATOP_DESTROY,(void(*)(void))MatDestroy_NEPDeflation);
<a name="line441">441: </a>    matctx-&gt;nep = extop-&gt;nep;
<a name="line442">442: </a>    matctx-&gt;extop = extop;
<a name="line443">443: </a>    <font color="#4169E1">if</font> (!M) {
<a name="line444">444: </a>      <font color="#4169E1">if</font> (jacobian) { matctx-&gt;jacob = PETSC_TRUE; matctx-&gt;T = extop-&gt;nep-&gt;jacobian; extop-&gt;MJ = Mshell; }
<a name="line445">445: </a>      <font color="#4169E1">else</font> { matctx-&gt;jacob = PETSC_FALSE; matctx-&gt;T = extop-&gt;nep-&gt;function; extop-&gt;MF = Mshell; }
<a name="line446">446: </a>      PetscObjectReference((PetscObject)matctx-&gt;T);
<a name="line447">447: </a>    } <font color="#4169E1">else</font> {
<a name="line448">448: </a>      matctx-&gt;jacob = jacobian;
<a name="line449">449: </a>      MatDuplicate(jacobian?extop-&gt;nep-&gt;jacobian:extop-&gt;nep-&gt;function,MAT_DO_NOT_COPY_VALUES, &amp;matctx-&gt;T);
<a name="line450">450: </a>      *M = Mshell;
<a name="line451">451: </a>    }
<a name="line452">452: </a>    <font color="#4169E1">if</font> (szd) {
<a name="line453">453: </a>      <a href="../../../docs/manualpages/BV/BVCreateVec.html#BVCreateVec">BVCreateVec</a>(extop-&gt;nep-&gt;V,matctx-&gt;w);
<a name="line454">454: </a>      VecDuplicate(matctx-&gt;w[0],matctx-&gt;w+1);
<a name="line455">455: </a>      <a href="../../../docs/manualpages/BV/BVDuplicateResize.html#BVDuplicateResize">BVDuplicateResize</a>(extop-&gt;nep-&gt;V,szd,&amp;matctx-&gt;U);
<a name="line456">456: </a>      PetscMalloc2(extop-&gt;simpU?2*(szd)*(szd):2*(szd)*(szd)*extop-&gt;nep-&gt;nt,&amp;matctx-&gt;hfj,szd,&amp;matctx-&gt;work);
<a name="line457">457: </a>      PetscMalloc2(szd*szd,&amp;matctx-&gt;A,szd*szd,&amp;matctx-&gt;B);
<a name="line458">458: </a>    }
<a name="line459">459: </a>  } <font color="#4169E1">else</font> {
<a name="line460">460: </a>    MatShellGetContext(Mshell,&amp;matctx);
<a name="line461">461: </a>  }
<a name="line462">462: </a>  <font color="#4169E1">if</font> (ini || matctx-&gt;theta != lambda || matctx-&gt;n != extop-&gt;n) {
<a name="line463">463: </a>    <font color="#4169E1">if</font> (ini || matctx-&gt;theta != lambda) {
<a name="line464">464: </a>      <font color="#4169E1">if</font> (jacobian) {
<a name="line465">465: </a>        <a href="../../../docs/manualpages/NEP/NEPComputeJacobian.html#NEPComputeJacobian">NEPComputeJacobian</a>(extop-&gt;nep,lambda,matctx-&gt;T);
<a name="line466">466: </a>      } <font color="#4169E1">else</font> {
<a name="line467">467: </a>        <a href="../../../docs/manualpages/NEP/NEPComputeFunction.html#NEPComputeFunction">NEPComputeFunction</a>(extop-&gt;nep,lambda,matctx-&gt;T,matctx-&gt;T);
<a name="line468">468: </a>      }
<a name="line469">469: </a>    }
<a name="line470">470: </a>    <font color="#4169E1">if</font> (n) {
<a name="line471">471: </a>      matctx-&gt;hfjset = PETSC_FALSE;
<a name="line472">472: </a>      <font color="#4169E1">if</font> (!extop-&gt;simpU) {
<a name="line473">473: </a>        <font color="#B22222">/* likely hfjp has been already computed */</font>
<a name="line474">474: </a>        <font color="#4169E1">if</font> (Mcomp) {
<a name="line475">475: </a>          MatShellGetContext(Mcomp,&amp;matctxC);
<a name="line476">476: </a>          <font color="#4169E1">if</font> (matctxC-&gt;hfjset &amp;&amp; matctxC-&gt;theta == lambda &amp;&amp; matctxC-&gt;n == extop-&gt;n) {
<a name="line477">477: </a>            PetscArraycpy(matctx-&gt;hfj,matctxC-&gt;hfj,2*extop-&gt;szd*extop-&gt;szd*extop-&gt;nep-&gt;nt);
<a name="line478">478: </a>            matctx-&gt;hfjset = PETSC_TRUE;
<a name="line479">479: </a>          }
<a name="line480">480: </a>        }
<a name="line481">481: </a>        hfj = matctx-&gt;hfj; hfjp = matctx-&gt;hfj+extop-&gt;szd*extop-&gt;szd*extop-&gt;nep-&gt;nt;
<a name="line482">482: </a>        <font color="#4169E1">if</font> (!matctx-&gt;hfjset) {
<a name="line483">483: </a>          NEPDeflationEvaluateHatFunction(extop,-1,lambda,NULL,hfj,hfjp,n);
<a name="line484">484: </a>          matctx-&gt;hfjset = PETSC_TRUE;
<a name="line485">485: </a>        }
<a name="line486">486: </a>        <a href="../../../docs/manualpages/BV/BVSetActiveColumns.html#BVSetActiveColumns">BVSetActiveColumns</a>(matctx-&gt;U,0,n);
<a name="line487">487: </a>        hf = jacobian?hfjp:hfj;
<a name="line488">488: </a>        MatCreateSeqDense(PETSC_COMM_SELF,n,n,hf,&amp;F);
<a name="line489">489: </a>        <a href="../../../docs/manualpages/BV/BVMatMult.html#BVMatMult">BVMatMult</a>(extop-&gt;X,extop-&gt;nep-&gt;A[0],matctx-&gt;U);
<a name="line490">490: </a>        <a href="../../../docs/manualpages/BV/BVMultInPlace.html#BVMultInPlace">BVMultInPlace</a>(matctx-&gt;U,F,0,n);
<a name="line491">491: </a>        <a href="../../../docs/manualpages/BV/BVSetActiveColumns.html#BVSetActiveColumns">BVSetActiveColumns</a>(extop-&gt;W,0,extop-&gt;n);
<a name="line492">492: </a>        <font color="#4169E1">for</font> (j=1;j&lt;extop-&gt;nep-&gt;nt;j++) {
<a name="line493">493: </a>          <a href="../../../docs/manualpages/BV/BVMatMult.html#BVMatMult">BVMatMult</a>(extop-&gt;X,extop-&gt;nep-&gt;A[j],extop-&gt;W);
<a name="line494">494: </a>          MatDensePlaceArray(F,hf+j*n*n);
<a name="line495">495: </a>          <a href="../../../docs/manualpages/BV/BVMult.html#BVMult">BVMult</a>(matctx-&gt;U,1.0,1.0,extop-&gt;W,F);
<a name="line496">496: </a>          MatDenseResetArray(F);
<a name="line497">497: </a>        }
<a name="line498">498: </a>        MatDestroy(&amp;F);
<a name="line499">499: </a>      } <font color="#4169E1">else</font> {
<a name="line500">500: </a>        hfj = matctx-&gt;hfj;
<a name="line501">501: </a>        <a href="../../../docs/manualpages/BV/BVSetActiveColumns.html#BVSetActiveColumns">BVSetActiveColumns</a>(matctx-&gt;U,0,n);
<a name="line502">502: </a>        <a href="../../../docs/manualpages/BV/BVMatMult.html#BVMatMult">BVMatMult</a>(extop-&gt;X,matctx-&gt;T,matctx-&gt;U);
<a name="line503">503: </a>        <font color="#4169E1">for</font> (j=0;j&lt;n;j++) {
<a name="line504">504: </a>          <font color="#4169E1">for</font> (i=0;i&lt;n;i++) hfj[j*n+i] = -extop-&gt;H[j*ldh+i];
<a name="line505">505: </a>          hfj[j*(n+1)] += lambda;
<a name="line506">506: </a>        }
<a name="line507">507: </a>        PetscBLASIntCast(n,&amp;n_);
<a name="line508">508: </a>        PetscFPTrapPush(PETSC_FP_TRAP_OFF);
<a name="line509">509: </a>        PetscStackCallBLAS(<font color="#666666">"LAPACKtrtri"</font>,LAPACKtrtri_(<font color="#666666">"U"</font>,<font color="#666666">"N"</font>,&amp;n_,hfj,&amp;n_,&amp;info));
<a name="line510">510: </a>        PetscFPTrapPop();
<a name="line511">511: </a>        SlepcCheckLapackInfo(<font color="#666666">"trtri"</font>,info);
<a name="line512">512: </a>        MatCreateSeqDense(PETSC_COMM_SELF,n,n,hfj,&amp;F);
<a name="line513">513: </a>        <a href="../../../docs/manualpages/BV/BVMultInPlace.html#BVMultInPlace">BVMultInPlace</a>(matctx-&gt;U,F,0,n);
<a name="line514">514: </a>        <font color="#4169E1">if</font> (jacobian) {
<a name="line515">515: </a>          NEPDeflationComputeFunction(extop,lambda,NULL);
<a name="line516">516: </a>          MatShellGetContext(extop-&gt;MF,&amp;matctxC);
<a name="line517">517: </a>          <a href="../../../docs/manualpages/BV/BVMult.html#BVMult">BVMult</a>(matctx-&gt;U,-1.0,1.0,matctxC-&gt;U,F);
<a name="line518">518: </a>        }
<a name="line519">519: </a>        MatDestroy(&amp;F);
<a name="line520">520: </a>      }
<a name="line521">521: </a>      PetscCalloc3(n,&amp;basisv,szd*szd,&amp;hH,szd*szd,&amp;hHprev);
<a name="line522">522: </a>      NEPDeflationEvaluateBasis(extop,lambda,n,basisv,jacobian);
<a name="line523">523: </a>      A = matctx-&gt;A;
<a name="line524">524: </a>      PetscArrayzero(A,szd*szd);
<a name="line525">525: </a>      <font color="#4169E1">if</font> (!jacobian) <font color="#4169E1">for</font> (i=0;i&lt;n;i++) A[i*(szd+1)] = 1.0;
<a name="line526">526: </a>      <font color="#4169E1">for</font> (j=0;j&lt;n;j++)
<a name="line527">527: </a>        <font color="#4169E1">for</font> (i=0;i&lt;n;i++)
<a name="line528">528: </a>          <font color="#4169E1">for</font> (k=1;k&lt;extop-&gt;midx;k++) A[j*szd+i] += basisv[k]*PetscConj(Hj[k*szd*szd+i*szd+j]);
<a name="line529">529: </a>      PetscBLASIntCast(n,&amp;n_);
<a name="line530">530: </a>      PetscBLASIntCast(szd,&amp;szd_);
<a name="line531">531: </a>      B = matctx-&gt;B;
<a name="line532">532: </a>      PetscArrayzero(B,szd*szd);
<a name="line533">533: </a>      <font color="#4169E1">for</font> (i=1;i&lt;extop-&gt;midx;i++) {
<a name="line534">534: </a>        NEPDeflationEvaluateBasisMat(extop,i,PETSC_TRUE,basisv,hH,hHprev);
<a name="line535">535: </a>        PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;n_,&amp;sone,extop-&gt;XpX,&amp;szd_,hH,&amp;szd_,&amp;zero,hHprev,&amp;szd_));
<a name="line536">536: </a>        PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"C"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;n_,&amp;sone,extop-&gt;Hj+szd*szd*i,&amp;szd_,hHprev,&amp;szd_,&amp;sone,B,&amp;szd_));
<a name="line537">537: </a>        pts = hHprev; hHprev = hH; hH = pts;
<a name="line538">538: </a>      }
<a name="line539">539: </a>      PetscFree3(basisv,hH,hHprev);
<a name="line540">540: </a>    }
<a name="line541">541: </a>    matctx-&gt;theta = lambda;
<a name="line542">542: </a>    matctx-&gt;n = extop-&gt;n;
<a name="line543">543: </a>  }
<a name="line544">544: </a>  <font color="#4169E1">return</font>(0);
<a name="line545">545: </a>}

<a name="line547">547: </a><strong><font color="#4169E1"><a name="NEPDeflationComputeFunction"></a>PetscErrorCode NEPDeflationComputeFunction(NEP_EXT_OP extop,PetscScalar lambda,Mat *F)</font></strong>
<a name="line548">548: </a>{

<a name="line552">552: </a>  NEPDeflationComputeShellMat(extop,lambda,PETSC_FALSE,NULL);
<a name="line553">553: </a>  <font color="#4169E1">if</font> (F) *F = extop-&gt;MF;
<a name="line554">554: </a>  <font color="#4169E1">return</font>(0);
<a name="line555">555: </a>}

<a name="line557">557: </a><strong><font color="#4169E1"><a name="NEPDeflationComputeJacobian"></a>PetscErrorCode NEPDeflationComputeJacobian(NEP_EXT_OP extop,PetscScalar lambda,Mat *J)</font></strong>
<a name="line558">558: </a>{

<a name="line562">562: </a>  NEPDeflationComputeShellMat(extop,lambda,PETSC_TRUE,NULL);
<a name="line563">563: </a>  <font color="#4169E1">if</font> (J) *J = extop-&gt;MJ;
<a name="line564">564: </a>  <font color="#4169E1">return</font>(0);
<a name="line565">565: </a>}

<a name="line567">567: </a><strong><font color="#4169E1"><a name="NEPDeflationSolveSetUp"></a>PetscErrorCode NEPDeflationSolveSetUp(NEP_EXT_OP extop,PetscScalar lambda)</font></strong>
<a name="line568">568: </a>{
<a name="line569">569: </a>  PetscErrorCode    ierr;
<a name="line570">570: </a>  NEP_DEF_MATSHELL  *matctx;
<a name="line571">571: </a>  NEP_DEF_FUN_SOLVE solve;
<a name="line572">572: </a>  PetscInt          i,j,n=extop-&gt;n;
<a name="line573">573: </a>  Vec               u,tu;
<a name="line574">574: </a>  Mat               F;
<a name="line575">575: </a>  PetscScalar       snone=-1.0,sone=1.0;
<a name="line576">576: </a>  PetscBLASInt      n_,szd_,ldh_,*p,info;
<a name="line577">577: </a>  Mat               Mshell;

<a name="line580">580: </a>  solve = extop-&gt;solve;
<a name="line581">581: </a>  <font color="#4169E1">if</font> (lambda!=solve-&gt;theta || n!=solve-&gt;n) {
<a name="line582">582: </a>    NEPDeflationComputeShellMat(extop,lambda,PETSC_FALSE,solve-&gt;sincf?NULL:&amp;solve-&gt;T);
<a name="line583">583: </a>    Mshell = (solve-&gt;sincf)?extop-&gt;MF:solve-&gt;T;
<a name="line584">584: </a>    MatShellGetContext(Mshell,&amp;matctx);
<a name="line585">585: </a>    KSPSetOperators(solve-&gt;ksp,matctx-&gt;T,matctx-&gt;T);
<a name="line586">586: </a>    <font color="#4169E1">if</font> (!extop-&gt;ref &amp;&amp; n) {
<a name="line587">587: </a>      PetscBLASIntCast(n,&amp;n_);
<a name="line588">588: </a>      PetscBLASIntCast(extop-&gt;szd,&amp;szd_);
<a name="line589">589: </a>      PetscBLASIntCast(extop-&gt;szd+1,&amp;ldh_);
<a name="line590">590: </a>      <font color="#4169E1">if</font> (!extop-&gt;simpU) {
<a name="line591">591: </a>        <a href="../../../docs/manualpages/BV/BVSetActiveColumns.html#BVSetActiveColumns">BVSetActiveColumns</a>(solve-&gt;T_1U,0,n);
<a name="line592">592: </a>        <font color="#4169E1">for</font> (i=0;i&lt;n;i++) {
<a name="line593">593: </a>          <a href="../../../docs/manualpages/BV/BVGetColumn.html#BVGetColumn">BVGetColumn</a>(matctx-&gt;U,i,&amp;u);
<a name="line594">594: </a>          <a href="../../../docs/manualpages/BV/BVGetColumn.html#BVGetColumn">BVGetColumn</a>(solve-&gt;T_1U,i,&amp;tu);
<a name="line595">595: </a>          KSPSolve(solve-&gt;ksp,u,tu);
<a name="line596">596: </a>          <a href="../../../docs/manualpages/BV/BVRestoreColumn.html#BVRestoreColumn">BVRestoreColumn</a>(solve-&gt;T_1U,i,&amp;tu);
<a name="line597">597: </a>          <a href="../../../docs/manualpages/BV/BVRestoreColumn.html#BVRestoreColumn">BVRestoreColumn</a>(matctx-&gt;U,i,&amp;u);
<a name="line598">598: </a>        }
<a name="line599">599: </a>        MatCreateSeqDense(PETSC_COMM_SELF,n,n,solve-&gt;work,&amp;F);
<a name="line600">600: </a>        <a href="../../../docs/manualpages/BV/BVDot.html#BVDot">BVDot</a>(solve-&gt;T_1U,extop-&gt;X,F);
<a name="line601">601: </a>        MatDestroy(&amp;F);
<a name="line602">602: </a>      } <font color="#4169E1">else</font> {
<a name="line603">603: </a>        <font color="#4169E1">for</font> (j=0;j&lt;n;j++)
<a name="line604">604: </a>          <font color="#4169E1">for</font> (i=0;i&lt;n;i++) solve-&gt;work[j*n+i] = extop-&gt;XpX[j*extop-&gt;szd+i];
<a name="line605">605: </a>        <font color="#4169E1">for</font> (i=0;i&lt;n;i++) extop-&gt;H[i*ldh_+i] -= lambda;
<a name="line606">606: </a>        PetscStackCallBLAS(<font color="#666666">"BLAStrsm"</font>,BLAStrsm_(<font color="#666666">"R"</font>,<font color="#666666">"U"</font>,<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;snone,extop-&gt;H,&amp;ldh_,solve-&gt;work,&amp;n_));
<a name="line607">607: </a>        <font color="#4169E1">for</font> (i=0;i&lt;n;i++) extop-&gt;H[i*ldh_+i] += lambda;
<a name="line608">608: </a>      }
<a name="line609">609: </a>      PetscArraycpy(solve-&gt;M,matctx-&gt;B,extop-&gt;szd*extop-&gt;szd);
<a name="line610">610: </a>      PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;n_,&amp;snone,matctx-&gt;A,&amp;szd_,solve-&gt;work,&amp;n_,&amp;sone,solve-&gt;M,&amp;szd_));
<a name="line611">611: </a>      PetscMalloc1(n,&amp;p);
<a name="line612">612: </a>      PetscFPTrapPush(PETSC_FP_TRAP_OFF);
<a name="line613">613: </a>      PetscStackCallBLAS(<font color="#666666">"LAPACKgetrf"</font>,LAPACKgetrf_(&amp;n_,&amp;n_,solve-&gt;M,&amp;szd_,p,&amp;info));
<a name="line614">614: </a>      SlepcCheckLapackInfo(<font color="#666666">"getrf"</font>,info);
<a name="line615">615: </a>      PetscStackCallBLAS(<font color="#666666">"LAPACKgetri"</font>,LAPACKgetri_(&amp;n_,solve-&gt;M,&amp;szd_,p,solve-&gt;work,&amp;n_,&amp;info));
<a name="line616">616: </a>      SlepcCheckLapackInfo(<font color="#666666">"getri"</font>,info);
<a name="line617">617: </a>      PetscFPTrapPop();
<a name="line618">618: </a>      PetscFree(p);
<a name="line619">619: </a>    }
<a name="line620">620: </a>    solve-&gt;theta = lambda;
<a name="line621">621: </a>    solve-&gt;n = n;
<a name="line622">622: </a>  }
<a name="line623">623: </a>  <font color="#4169E1">return</font>(0);
<a name="line624">624: </a>}

<a name="line626">626: </a><strong><font color="#4169E1"><a name="NEPDeflationFunctionSolve"></a>PetscErrorCode NEPDeflationFunctionSolve(NEP_EXT_OP extop,Vec b,Vec x)</font></strong>
<a name="line627">627: </a>{
<a name="line628">628: </a>  PetscErrorCode    ierr;
<a name="line629">629: </a>  Vec               b1,x1;
<a name="line630">630: </a>  PetscScalar       *xx,*bb,*x2,*b2,*w,*w2,snone=-1.0,sone=1.0,zero=0.0;
<a name="line631">631: </a>  NEP_DEF_MATSHELL  *matctx;
<a name="line632">632: </a>  NEP_DEF_FUN_SOLVE solve=extop-&gt;solve;
<a name="line633">633: </a>  PetscBLASInt      one=1,szd_,n_,ldh_;
<a name="line634">634: </a>  PetscInt          nloc,i;
<a name="line635">635: </a>  PetscMPIInt       np,count;

<a name="line638">638: </a>  <font color="#4169E1">if</font> (extop-&gt;ref) {
<a name="line639">639: </a>    VecZeroEntries(x);
<a name="line640">640: </a>  }
<a name="line641">641: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line642">642: </a>    x1 = solve-&gt;w[0]; b1 = solve-&gt;w[1];
<a name="line643">643: </a>    VecGetArray(x,&amp;xx);
<a name="line644">644: </a>    VecPlaceArray(x1,xx);
<a name="line645">645: </a>    VecGetArray(b,&amp;bb);
<a name="line646">646: </a>    VecPlaceArray(b1,bb);
<a name="line647">647: </a>  } <font color="#4169E1">else</font> {
<a name="line648">648: </a>    b1 = b; x1 = x;
<a name="line649">649: </a>  }
<a name="line650">650: </a>  KSPSolve(extop-&gt;solve-&gt;ksp,b1,x1);
<a name="line651">651: </a>  <font color="#4169E1">if</font> (!extop-&gt;ref &amp;&amp; extop-&gt;n) {
<a name="line652">652: </a>    PetscBLASIntCast(extop-&gt;szd,&amp;szd_);
<a name="line653">653: </a>    PetscBLASIntCast(extop-&gt;n,&amp;n_);
<a name="line654">654: </a>    PetscBLASIntCast(extop-&gt;szd+1,&amp;ldh_);
<a name="line655">655: </a>    <a href="../../../docs/manualpages/BV/BVGetSizes.html#BVGetSizes">BVGetSizes</a>(extop-&gt;nep-&gt;V,&amp;nloc,NULL,NULL);
<a name="line656">656: </a>    PetscMalloc2(extop-&gt;n,&amp;b2,extop-&gt;n,&amp;x2);
<a name="line657">657: </a>    <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(PetscObjectComm((PetscObject)b),&amp;np);
<a name="line658">658: </a>    <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) b2[i] = bb[nloc+i]*PetscSqrtReal(np);
<a name="line659">659: </a>    w = solve-&gt;work; w2 = solve-&gt;work+extop-&gt;n;
<a name="line660">660: </a>    MatShellGetContext(solve-&gt;sincf?extop-&gt;MF:solve-&gt;T,&amp;matctx);
<a name="line661">661: </a>    PetscArraycpy(w2,b2,extop-&gt;n);
<a name="line662">662: </a>    <a href="../../../docs/manualpages/BV/BVDotVec.html#BVDotVec">BVDotVec</a>(extop-&gt;X,x1,w);
<a name="line663">663: </a>    PetscStackCallBLAS(<font color="#666666">"BLASgemv"</font>,BLASgemv_(<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;snone,matctx-&gt;A,&amp;szd_,w,&amp;one,&amp;sone,w2,&amp;one));
<a name="line664">664: </a>    PetscStackCallBLAS(<font color="#666666">"BLASgemv"</font>,BLASgemv_(<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;sone,solve-&gt;M,&amp;szd_,w2,&amp;one,&amp;zero,x2,&amp;one));
<a name="line665">665: </a>    <font color="#4169E1">if</font> (extop-&gt;simpU) {
<a name="line666">666: </a>      <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) extop-&gt;H[i+i*(extop-&gt;szd+1)] -= solve-&gt;theta;
<a name="line667">667: </a>      <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) w[i] = x2[i];
<a name="line668">668: </a>      PetscStackCallBLAS(<font color="#666666">"BLAStrsm"</font>,BLAStrsm_(<font color="#666666">"L"</font>,<font color="#666666">"U"</font>,<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;one,&amp;snone,extop-&gt;H,&amp;ldh_,w,&amp;n_));
<a name="line669">669: </a>      <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) extop-&gt;H[i+i*(extop-&gt;szd+1)] += solve-&gt;theta;
<a name="line670">670: </a>      <a href="../../../docs/manualpages/BV/BVMultVec.html#BVMultVec">BVMultVec</a>(extop-&gt;X,-1.0,1.0,x1,w);
<a name="line671">671: </a>    } <font color="#4169E1">else</font> {
<a name="line672">672: </a>      <a href="../../../docs/manualpages/BV/BVMultVec.html#BVMultVec">BVMultVec</a>(solve-&gt;T_1U,-1.0,1.0,x1,x2);
<a name="line673">673: </a>    }
<a name="line674">674: </a>    <font color="#4169E1">for</font> (i=0;i&lt;extop-&gt;n;i++) xx[i+nloc] = x2[i]/PetscSqrtReal(np);
<a name="line675">675: </a>    PetscMPIIntCast(extop-&gt;n,&amp;count);
<a name="line676">676: </a>    <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Bcast.html#MPI_Bcast">MPI_Bcast</a>(xx+nloc,count,MPIU_SCALAR,np-1,PetscObjectComm((PetscObject)b));
<a name="line677">677: </a>  }
<a name="line678">678: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line679">679: </a>    VecResetArray(x1);
<a name="line680">680: </a>    VecRestoreArray(x,&amp;xx);
<a name="line681">681: </a>    VecResetArray(b1);
<a name="line682">682: </a>    VecRestoreArray(b,&amp;bb);
<a name="line683">683: </a>    <font color="#4169E1">if</font> (!extop-&gt;ref &amp;&amp; extop-&gt;n) { PetscFree2(b2,x2);}
<a name="line684">684: </a>  }
<a name="line685">685: </a>  <font color="#4169E1">return</font>(0);
<a name="line686">686: </a>}

<a name="line688">688: </a><strong><font color="#4169E1"><a name="NEPDeflationSetRefine"></a>PetscErrorCode NEPDeflationSetRefine(NEP_EXT_OP extop,PetscBool ref)</font></strong>
<a name="line689">689: </a>{
<a name="line691">691: </a>  extop-&gt;ref = ref;
<a name="line692">692: </a>  <font color="#4169E1">return</font>(0);
<a name="line693">693: </a>}

<a name="line695">695: </a><strong><font color="#4169E1"><a name="NEPDeflationReset"></a>PetscErrorCode NEPDeflationReset(NEP_EXT_OP extop)</font></strong>
<a name="line696">696: </a>{
<a name="line697">697: </a>  PetscErrorCode    ierr;
<a name="line698">698: </a>  PetscInt          j;
<a name="line699">699: </a>  NEP_DEF_FUN_SOLVE solve;

<a name="line702">702: </a>  <font color="#4169E1">if</font> (!extop) <font color="#4169E1">return</font>(0);
<a name="line703">703: </a>  PetscFree(extop-&gt;H);
<a name="line704">704: </a>  <a href="../../../docs/manualpages/BV/BVDestroy.html#BVDestroy">BVDestroy</a>(&amp;extop-&gt;X);
<a name="line705">705: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line706">706: </a>    VecDestroy(&amp;extop-&gt;w);
<a name="line707">707: </a>    PetscFree3(extop-&gt;Hj,extop-&gt;XpX,extop-&gt;bc);
<a name="line708">708: </a>    <a href="../../../docs/manualpages/BV/BVDestroy.html#BVDestroy">BVDestroy</a>(&amp;extop-&gt;W);
<a name="line709">709: </a>  }
<a name="line710">710: </a>  MatDestroy(&amp;extop-&gt;MF);
<a name="line711">711: </a>  MatDestroy(&amp;extop-&gt;MJ);
<a name="line712">712: </a>  <font color="#4169E1">if</font> (extop-&gt;solve) {
<a name="line713">713: </a>    solve = extop-&gt;solve;
<a name="line714">714: </a>    <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line715">715: </a>      <font color="#4169E1">if</font> (!extop-&gt;simpU) {<a href="../../../docs/manualpages/BV/BVDestroy.html#BVDestroy">BVDestroy</a>(&amp;solve-&gt;T_1U);}
<a name="line716">716: </a>      PetscFree2(solve-&gt;M,solve-&gt;work);
<a name="line717">717: </a>      VecDestroy(&amp;solve-&gt;w[0]);
<a name="line718">718: </a>      VecDestroy(&amp;solve-&gt;w[1]);
<a name="line719">719: </a>    }
<a name="line720">720: </a>    <font color="#4169E1">if</font> (!solve-&gt;sincf) {
<a name="line721">721: </a>      MatDestroy(&amp;solve-&gt;T);
<a name="line722">722: </a>    }
<a name="line723">723: </a>    PetscFree(extop-&gt;solve);
<a name="line724">724: </a>  }
<a name="line725">725: </a>  <font color="#4169E1">if</font> (extop-&gt;proj) {
<a name="line726">726: </a>    <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line727">727: </a>      <font color="#4169E1">for</font> (j=0;j&lt;extop-&gt;nep-&gt;nt;j++) {MatDestroy(&amp;extop-&gt;proj-&gt;V1pApX[j]);}
<a name="line728">728: </a>      MatDestroy(&amp;extop-&gt;proj-&gt;XpV1);
<a name="line729">729: </a>      PetscFree3(extop-&gt;proj-&gt;V2,extop-&gt;proj-&gt;V1pApX,extop-&gt;proj-&gt;work);
<a name="line730">730: </a>      VecDestroy(&amp;extop-&gt;proj-&gt;w);
<a name="line731">731: </a>      <a href="../../../docs/manualpages/BV/BVDestroy.html#BVDestroy">BVDestroy</a>(&amp;extop-&gt;proj-&gt;V1);
<a name="line732">732: </a>    }
<a name="line733">733: </a>    PetscFree(extop-&gt;proj);
<a name="line734">734: </a>  }
<a name="line735">735: </a>  PetscFree(extop);
<a name="line736">736: </a>  <font color="#4169E1">return</font>(0);
<a name="line737">737: </a>}

<a name="line739">739: </a><strong><font color="#4169E1"><a name="NEPDeflationInitialize"></a>PetscErrorCode NEPDeflationInitialize(<a href="../../../docs/manualpages/sys/NEP.html#NEP">NEP</a> nep,<a href="../../../docs/manualpages/sys/BV.html#BV">BV</a> X,KSP ksp,PetscBool sincfun,PetscInt sz,NEP_EXT_OP *extop)</font></strong>
<a name="line740">740: </a>{
<a name="line741">741: </a>  PetscErrorCode    ierr;
<a name="line742">742: </a>  NEP_EXT_OP        op;
<a name="line743">743: </a>  NEP_DEF_FUN_SOLVE solve;
<a name="line744">744: </a>  PetscInt          szd;
<a name="line745">745: </a>  Vec               x;

<a name="line748">748: </a>  NEPDeflationReset(*extop);
<a name="line749">749: </a>  PetscNew(&amp;op);
<a name="line750">750: </a>  *extop  = op;
<a name="line751">751: </a>  op-&gt;nep = nep;
<a name="line752">752: </a>  op-&gt;n   = 0;
<a name="line753">753: </a>  op-&gt;szd = szd = sz-1;
<a name="line754">754: </a>  op-&gt;max_midx = PetscMin(MAX_MINIDX,szd);
<a name="line755">755: </a>  op-&gt;X = X;
<a name="line756">756: </a>  <font color="#4169E1">if</font> (!X) { <a href="../../../docs/manualpages/BV/BVDuplicateResize.html#BVDuplicateResize">BVDuplicateResize</a>(nep-&gt;V,sz,&amp;op-&gt;X); }
<a name="line757">757: </a>  <font color="#4169E1">else</font> { PetscObjectReference((PetscObject)X); }
<a name="line758">758: </a>  PetscCalloc1(sz*sz,&amp;(op)-&gt;H);
<a name="line759">759: </a>  <font color="#4169E1">if</font> (op-&gt;szd) {
<a name="line760">760: </a>    <a href="../../../docs/manualpages/BV/BVGetColumn.html#BVGetColumn">BVGetColumn</a>(op-&gt;X,0,&amp;x);
<a name="line761">761: </a>    VecDuplicate(x,&amp;op-&gt;w);
<a name="line762">762: </a>    <a href="../../../docs/manualpages/BV/BVRestoreColumn.html#BVRestoreColumn">BVRestoreColumn</a>(op-&gt;X,0,&amp;x);
<a name="line763">763: </a>    op-&gt;simpU = PETSC_FALSE;
<a name="line764">764: </a>    <font color="#4169E1">if</font> (nep-&gt;fui==NEP_USER_INTERFACE_SPLIT) {
<a name="line765">765: </a>      <font color="#B22222">/* undocumented option to use the simple expression for U = T*X*inv(lambda-H) */</font>
<a name="line766">766: </a>      PetscOptionsGetBool(NULL,NULL,<font color="#666666">"-nep_deflation_simpleu"</font>,&amp;op-&gt;simpU,NULL);
<a name="line767">767: </a>    } <font color="#4169E1">else</font> {
<a name="line768">768: </a>      op-&gt;simpU = PETSC_TRUE;
<a name="line769">769: </a>    }
<a name="line770">770: </a>    PetscCalloc3(szd*szd*op-&gt;max_midx,&amp;(op)-&gt;Hj,szd*szd,&amp;(op)-&gt;XpX,szd,&amp;op-&gt;bc);
<a name="line771">771: </a>    <a href="../../../docs/manualpages/BV/BVDuplicateResize.html#BVDuplicateResize">BVDuplicateResize</a>(op-&gt;X,op-&gt;szd,&amp;op-&gt;W);
<a name="line772">772: </a>  }
<a name="line773">773: </a>  <font color="#4169E1">if</font> (ksp) {
<a name="line774">774: </a>    PetscNew(&amp;solve);
<a name="line775">775: </a>    op-&gt;solve    = solve;
<a name="line776">776: </a>    solve-&gt;ksp   = ksp;
<a name="line777">777: </a>    solve-&gt;sincf = sincfun;
<a name="line778">778: </a>    solve-&gt;n     = -1;
<a name="line779">779: </a>    <font color="#4169E1">if</font> (op-&gt;szd) {
<a name="line780">780: </a>      <font color="#4169E1">if</font> (!op-&gt;simpU) {
<a name="line781">781: </a>        <a href="../../../docs/manualpages/BV/BVDuplicateResize.html#BVDuplicateResize">BVDuplicateResize</a>(nep-&gt;V,szd,&amp;solve-&gt;T_1U);
<a name="line782">782: </a>      }
<a name="line783">783: </a>      PetscMalloc2(szd*szd,&amp;solve-&gt;M,2*szd*szd,&amp;solve-&gt;work);
<a name="line784">784: </a>      <a href="../../../docs/manualpages/BV/BVCreateVec.html#BVCreateVec">BVCreateVec</a>(nep-&gt;V,&amp;solve-&gt;w[0]);
<a name="line785">785: </a>      VecDuplicate(solve-&gt;w[0],&amp;solve-&gt;w[1]);
<a name="line786">786: </a>    }
<a name="line787">787: </a>  }
<a name="line788">788: </a>  <font color="#4169E1">return</font>(0);
<a name="line789">789: </a>}

<a name="line791">791: </a><strong><font color="#4169E1"><a name="NEPDeflationDSNEPComputeMatrix"></a>PetscErrorCode NEPDeflationDSNEPComputeMatrix(<a href="../../../docs/manualpages/sys/DS.html#DS">DS</a> ds,PetscScalar lambda,PetscBool deriv,<a href="../../../docs/manualpages/sys/DSMatType.html#DSMatType">DSMatType</a> mat,void *ctx)</font></strong>
<a name="line792">792: </a>{
<a name="line793">793: </a>  PetscScalar       *T,*Ei,*w1,*w2,*w=NULL,*ww,*hH,*hHprev,*pts;
<a name="line794">794: </a>  PetscScalar       alpha,alpha2,*AB,sone=1.0,zero=0.0,*basisv,s;
<a name="line795">795: </a>  const PetscScalar *E;
<a name="line796">796: </a>  PetscInt          i,ldds,nwork=0,szd,nv,j,k,n;
<a name="line797">797: </a>  PetscBLASInt      inc=1,nv_,ldds_,dim_,dim2,szdk,szd_,n_,ldh_;
<a name="line798">798: </a>  PetscMPIInt       np;
<a name="line799">799: </a>  NEP_DEF_PROJECT   proj=(NEP_DEF_PROJECT)ctx;
<a name="line800">800: </a>  NEP_EXT_OP        extop=proj-&gt;extop;
<a name="line801">801: </a>  <a href="../../../docs/manualpages/sys/NEP.html#NEP">NEP</a>               nep=extop-&gt;nep;
<a name="line802">802: </a>  PetscErrorCode    ierr;

<a name="line805">805: </a>  <a href="../../../docs/manualpages/DS/DSGetDimensions.html#DSGetDimensions">DSGetDimensions</a>(ds,&amp;nv,NULL,NULL,NULL);
<a name="line806">806: </a>  <a href="../../../docs/manualpages/DS/DSGetLeadingDimension.html#DSGetLeadingDimension">DSGetLeadingDimension</a>(ds,&amp;ldds);
<a name="line807">807: </a>  <a href="../../../docs/manualpages/DS/DSGetArray.html#DSGetArray">DSGetArray</a>(ds,mat,&amp;T);
<a name="line808">808: </a>  PetscArrayzero(T,ldds*nv);
<a name="line809">809: </a>  PetscBLASIntCast(ldds*nv,&amp;dim2);
<a name="line810">810: </a>  <font color="#B22222">/* mat = V1^*T(lambda)V1 */</font>
<a name="line811">811: </a>  <font color="#4169E1">for</font> (i=0;i&lt;nep-&gt;nt;i++) {
<a name="line812">812: </a>    <font color="#4169E1">if</font> (deriv) {
<a name="line813">813: </a>      <a href="../../../docs/manualpages/FN/FNEvaluateDerivative.html#FNEvaluateDerivative">FNEvaluateDerivative</a>(nep-&gt;f[i],lambda,&amp;alpha);
<a name="line814">814: </a>    } <font color="#4169E1">else</font> {
<a name="line815">815: </a>      <a href="../../../docs/manualpages/FN/FNEvaluateFunction.html#FNEvaluateFunction">FNEvaluateFunction</a>(nep-&gt;f[i],lambda,&amp;alpha);
<a name="line816">816: </a>    }
<a name="line817">817: </a>    <a href="../../../docs/manualpages/DS/DSGetArray.html#DSGetArray">DSGetArray</a>(ds,DSMatExtra[i],&amp;Ei);
<a name="line818">818: </a>    PetscStackCallBLAS(<font color="#666666">"BLASaxpy"</font>,BLASaxpy_(&amp;dim2,&amp;alpha,Ei,&amp;inc,T,&amp;inc));
<a name="line819">819: </a>    <a href="../../../docs/manualpages/DS/DSRestoreArray.html#DSRestoreArray">DSRestoreArray</a>(ds,DSMatExtra[i],&amp;Ei);
<a name="line820">820: </a>  }
<a name="line821">821: </a>  <font color="#4169E1">if</font> (!extop-&gt;ref &amp;&amp; extop-&gt;n) {
<a name="line822">822: </a>    n = extop-&gt;n;
<a name="line823">823: </a>    szd = extop-&gt;szd;
<a name="line824">824: </a>    PetscArrayzero(proj-&gt;work,proj-&gt;lwork);
<a name="line825">825: </a>    PetscBLASIntCast(nv,&amp;nv_);
<a name="line826">826: </a>    PetscBLASIntCast(n,&amp;n_);
<a name="line827">827: </a>    PetscBLASIntCast(ldds,&amp;ldds_);
<a name="line828">828: </a>    PetscBLASIntCast(szd,&amp;szd_);
<a name="line829">829: </a>    PetscBLASIntCast(proj-&gt;dim,&amp;dim_);
<a name="line830">830: </a>    PetscBLASIntCast(extop-&gt;szd+1,&amp;ldh_);
<a name="line831">831: </a>    w1 = proj-&gt;work; w2 = proj-&gt;work+proj-&gt;dim*proj-&gt;dim;
<a name="line832">832: </a>    nwork += 2*proj-&gt;dim*proj-&gt;dim;

<a name="line834">834: </a>    <font color="#B22222">/* mat = mat + V1^*U(lambda)V2 */</font>
<a name="line835">835: </a>    <font color="#4169E1">for</font> (i=0;i&lt;nep-&gt;nt;i++) {
<a name="line836">836: </a>      <font color="#4169E1">if</font> (extop-&gt;simpU) {
<a name="line837">837: </a>        <font color="#4169E1">if</font> (deriv) {
<a name="line838">838: </a>          <a href="../../../docs/manualpages/FN/FNEvaluateDerivative.html#FNEvaluateDerivative">FNEvaluateDerivative</a>(nep-&gt;f[i],lambda,&amp;alpha);
<a name="line839">839: </a>        } <font color="#4169E1">else</font> {
<a name="line840">840: </a>          <a href="../../../docs/manualpages/FN/FNEvaluateFunction.html#FNEvaluateFunction">FNEvaluateFunction</a>(nep-&gt;f[i],lambda,&amp;alpha);
<a name="line841">841: </a>        }
<a name="line842">842: </a>        ww = w1; w = w2;
<a name="line843">843: </a>        PetscArraycpy(ww,proj-&gt;V2,szd*nv);
<a name="line844">844: </a>        <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(PetscObjectComm((PetscObject)ds),&amp;np);
<a name="line845">845: </a>        <font color="#4169E1">for</font> (j=0;j&lt;szd*nv;j++) ww[j] *= PetscSqrtReal(np);
<a name="line846">846: </a>        <font color="#4169E1">for</font> (j=0;j&lt;n;j++) extop-&gt;H[j*ldh_+j] -= lambda;
<a name="line847">847: </a>        alpha = -alpha;
<a name="line848">848: </a>        PetscStackCallBLAS(<font color="#666666">"BLAStrsm"</font>,BLAStrsm_(<font color="#666666">"L"</font>,<font color="#666666">"U"</font>,<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;nv_,&amp;alpha,extop-&gt;H,&amp;ldh_,ww,&amp;szd_));
<a name="line849">849: </a>        <font color="#4169E1">if</font> (deriv) {
<a name="line850">850: </a>          PetscBLASIntCast(szd*nv,&amp;szdk);
<a name="line851">851: </a>          <a href="../../../docs/manualpages/FN/FNEvaluateFunction.html#FNEvaluateFunction">FNEvaluateFunction</a>(nep-&gt;f[i],lambda,&amp;alpha2);
<a name="line852">852: </a>          PetscArraycpy(w,proj-&gt;V2,szd*nv);
<a name="line853">853: </a>          <font color="#4169E1">for</font> (j=0;j&lt;szd*nv;j++) w[j] *= PetscSqrtReal(np);
<a name="line854">854: </a>          alpha2 = -alpha2;
<a name="line855">855: </a>          PetscStackCallBLAS(<font color="#666666">"BLAStrsm"</font>,BLAStrsm_(<font color="#666666">"L"</font>,<font color="#666666">"U"</font>,<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;nv_,&amp;alpha2,extop-&gt;H,&amp;ldh_,w,&amp;szd_));
<a name="line856">856: </a>          alpha2 = 1.0;
<a name="line857">857: </a>          PetscStackCallBLAS(<font color="#666666">"BLAStrsm"</font>,BLAStrsm_(<font color="#666666">"L"</font>,<font color="#666666">"U"</font>,<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;nv_,&amp;alpha2,extop-&gt;H,&amp;ldh_,w,&amp;szd_));
<a name="line858">858: </a>          PetscStackCallBLAS(<font color="#666666">"BLASaxpy"</font>,BLASaxpy_(&amp;szdk,&amp;sone,w,&amp;inc,ww,&amp;inc));
<a name="line859">859: </a>        }
<a name="line860">860: </a>        <font color="#4169E1">for</font> (j=0;j&lt;n;j++) extop-&gt;H[j*ldh_+j] += lambda;
<a name="line861">861: </a>      } <font color="#4169E1">else</font> {
<a name="line862">862: </a>        NEPDeflationEvaluateHatFunction(extop,i,lambda,NULL,w1,w2,szd);
<a name="line863">863: </a>        w = deriv?w2:w1; ww = deriv?w1:w2;
<a name="line864">864: </a>        <a href="http://www.mpich.org/static/docs/latest/www3/MPI_Comm_size.html#MPI_Comm_size">MPI_Comm_size</a>(PetscObjectComm((PetscObject)ds),&amp;np);
<a name="line865">865: </a>        s = PetscSqrtReal(np);
<a name="line866">866: </a>        PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;nv_,&amp;n_,&amp;s,w,&amp;szd_,proj-&gt;V2,&amp;szd_,&amp;zero,ww,&amp;szd_));
<a name="line867">867: </a>      }
<a name="line868">868: </a>      MatDenseGetArrayRead(proj-&gt;V1pApX[i],&amp;E);
<a name="line869">869: </a>      PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;nv_,&amp;nv_,&amp;n_,&amp;sone,E,&amp;dim_,ww,&amp;szd_,&amp;sone,T,&amp;ldds_));
<a name="line870">870: </a>      MatDenseRestoreArrayRead(proj-&gt;V1pApX[i],&amp;E);
<a name="line871">871: </a>    }

<a name="line873">873: </a>    <font color="#B22222">/* mat = mat + V2^*A(lambda)V1 */</font>
<a name="line874">874: </a>    basisv = proj-&gt;work+nwork; nwork += szd;
<a name="line875">875: </a>    hH     = proj-&gt;work+nwork; nwork += szd*szd;
<a name="line876">876: </a>    hHprev = proj-&gt;work+nwork; nwork += szd*szd;
<a name="line877">877: </a>    AB     = proj-&gt;work+nwork;
<a name="line878">878: </a>    NEPDeflationEvaluateBasis(extop,lambda,n,basisv,deriv);
<a name="line879">879: </a>    <font color="#4169E1">if</font> (!deriv) <font color="#4169E1">for</font> (i=0;i&lt;n;i++) AB[i*(szd+1)] = 1.0;
<a name="line880">880: </a>    <font color="#4169E1">for</font> (j=0;j&lt;n;j++)
<a name="line881">881: </a>      <font color="#4169E1">for</font> (i=0;i&lt;n;i++)
<a name="line882">882: </a>        <font color="#4169E1">for</font> (k=1;k&lt;extop-&gt;midx;k++) AB[j*szd+i] += basisv[k]*PetscConj(extop-&gt;Hj[k*szd*szd+i*szd+j]);
<a name="line883">883: </a>    MatDenseGetArrayRead(proj-&gt;XpV1,&amp;E);
<a name="line884">884: </a>    PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;nv_,&amp;n_,&amp;sone,AB,&amp;szd_,E,&amp;szd_,&amp;zero,w,&amp;szd_));
<a name="line885">885: </a>    PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"C"</font>,<font color="#666666">"N"</font>,&amp;nv_,&amp;nv_,&amp;n_,&amp;sone,proj-&gt;V2,&amp;szd_,w,&amp;szd_,&amp;sone,T,&amp;ldds_));
<a name="line886">886: </a>    MatDenseRestoreArrayRead(proj-&gt;XpV1,&amp;E);

<a name="line888">888: </a>    <font color="#B22222">/* mat = mat + V2^*B(lambda)V2 */</font>
<a name="line889">889: </a>    PetscArrayzero(AB,szd*szd);
<a name="line890">890: </a>    <font color="#4169E1">for</font> (i=1;i&lt;extop-&gt;midx;i++) {
<a name="line891">891: </a>      NEPDeflationEvaluateBasisMat(extop,i,PETSC_TRUE,basisv,hH,hHprev);
<a name="line892">892: </a>      PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;n_,&amp;sone,extop-&gt;XpX,&amp;szd_,hH,&amp;szd_,&amp;zero,hHprev,&amp;szd_));
<a name="line893">893: </a>      PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"C"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;n_,&amp;n_,&amp;sone,extop-&gt;Hj+szd*szd*i,&amp;szd_,hHprev,&amp;szd_,&amp;sone,AB,&amp;szd_));
<a name="line894">894: </a>      pts = hHprev; hHprev = hH; hH = pts;
<a name="line895">895: </a>    }
<a name="line896">896: </a>    PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"N"</font>,<font color="#666666">"N"</font>,&amp;n_,&amp;nv_,&amp;n_,&amp;sone,AB,&amp;szd_,proj-&gt;V2,&amp;szd_,&amp;zero,w,&amp;szd_));
<a name="line897">897: </a>    PetscStackCallBLAS(<font color="#666666">"BLASgemm"</font>,BLASgemm_(<font color="#666666">"C"</font>,<font color="#666666">"N"</font>,&amp;nv_,&amp;nv_,&amp;n_,&amp;sone,proj-&gt;V2,&amp;szd_,w,&amp;szd_,&amp;sone,T,&amp;ldds_));
<a name="line898">898: </a>  }
<a name="line899">899: </a>  <a href="../../../docs/manualpages/DS/DSRestoreArray.html#DSRestoreArray">DSRestoreArray</a>(ds,mat,&amp;T);
<a name="line900">900: </a>  <font color="#4169E1">return</font>(0);
<a name="line901">901: </a>}

<a name="line903">903: </a><strong><font color="#4169E1"><a name="NEPDeflationProjectOperator"></a>PetscErrorCode NEPDeflationProjectOperator(NEP_EXT_OP extop,<a href="../../../docs/manualpages/sys/BV.html#BV">BV</a> Vext,<a href="../../../docs/manualpages/sys/DS.html#DS">DS</a> ds,PetscInt j0,PetscInt j1)</font></strong>
<a name="line904">904: </a>{
<a name="line905">905: </a>  PetscErrorCode  ierr;
<a name="line906">906: </a>  PetscInt        k,j,n=extop-&gt;n,dim;
<a name="line907">907: </a>  Vec             v,ve;
<a name="line908">908: </a>  <a href="../../../docs/manualpages/sys/BV.html#BV">BV</a>              V1;
<a name="line909">909: </a>  Mat             G;
<a name="line910">910: </a>  <a href="../../../docs/manualpages/sys/NEP.html#NEP">NEP</a>             nep=extop-&gt;nep;
<a name="line911">911: </a>  NEP_DEF_PROJECT proj;

<a name="line914">914: </a>  NEPCheckSplit(extop-&gt;nep,1);
<a name="line915">915: </a>  proj = extop-&gt;proj;
<a name="line916">916: </a>  <font color="#4169E1">if</font> (!proj) {
<a name="line917">917: </a>    <font color="#B22222">/* Initialize the projection data structure */</font>
<a name="line918">918: </a>    PetscNew(&amp;proj);
<a name="line919">919: </a>    extop-&gt;proj = proj;
<a name="line920">920: </a>    proj-&gt;extop = extop;
<a name="line921">921: </a>    <a href="../../../docs/manualpages/BV/BVGetSizes.html#BVGetSizes">BVGetSizes</a>(Vext,NULL,NULL,&amp;dim);
<a name="line922">922: </a>    proj-&gt;dim = dim;
<a name="line923">923: </a>    <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line924">924: </a>      proj-&gt;lwork = 3*dim*dim+2*extop-&gt;szd*extop-&gt;szd+extop-&gt;szd;
<a name="line925">925: </a>      PetscMalloc3(dim*extop-&gt;szd,&amp;proj-&gt;V2,nep-&gt;nt,&amp;proj-&gt;V1pApX,proj-&gt;lwork,&amp;proj-&gt;work);
<a name="line926">926: </a>      <font color="#4169E1">for</font> (j=0;j&lt;nep-&gt;nt;j++) {
<a name="line927">927: </a>         MatCreateSeqDense(PETSC_COMM_SELF,proj-&gt;dim,extop-&gt;szd,NULL,&amp;proj-&gt;V1pApX[j]);
<a name="line928">928: </a>      }
<a name="line929">929: </a>       MatCreateSeqDense(PETSC_COMM_SELF,extop-&gt;szd,proj-&gt;dim,NULL,&amp;proj-&gt;XpV1);
<a name="line930">930: </a>      <a href="../../../docs/manualpages/BV/BVCreateVec.html#BVCreateVec">BVCreateVec</a>(extop-&gt;X,&amp;proj-&gt;w);
<a name="line931">931: </a>      <a href="../../../docs/manualpages/BV/BVDuplicateResize.html#BVDuplicateResize">BVDuplicateResize</a>(extop-&gt;X,proj-&gt;dim,&amp;proj-&gt;V1);
<a name="line932">932: </a>    }
<a name="line933">933: </a>    <a href="../../../docs/manualpages/DS/DSNEPSetComputeMatrixFunction.html#DSNEPSetComputeMatrixFunction">DSNEPSetComputeMatrixFunction</a>(ds,NEPDeflationDSNEPComputeMatrix,(void*)proj);
<a name="line934">934: </a>  }

<a name="line936">936: </a>  <font color="#B22222">/* Split Vext in V1 and V2 */</font>
<a name="line937">937: </a>  <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line938">938: </a>    <font color="#4169E1">for</font> (j=j0;j&lt;j1;j++) {
<a name="line939">939: </a>      <a href="../../../docs/manualpages/BV/BVGetColumn.html#BVGetColumn">BVGetColumn</a>(Vext,j,&amp;ve);
<a name="line940">940: </a>      <a href="../../../docs/manualpages/BV/BVGetColumn.html#BVGetColumn">BVGetColumn</a>(proj-&gt;V1,j,&amp;v);
<a name="line941">941: </a>      NEPDeflationCopyToExtendedVec(extop,v,proj-&gt;V2+j*extop-&gt;szd,ve,PETSC_TRUE);
<a name="line942">942: </a>      <a href="../../../docs/manualpages/BV/BVRestoreColumn.html#BVRestoreColumn">BVRestoreColumn</a>(proj-&gt;V1,j,&amp;v);
<a name="line943">943: </a>      <a href="../../../docs/manualpages/BV/BVRestoreColumn.html#BVRestoreColumn">BVRestoreColumn</a>(Vext,j,&amp;ve);
<a name="line944">944: </a>    }
<a name="line945">945: </a>    V1 = proj-&gt;V1;
<a name="line946">946: </a>  } <font color="#4169E1">else</font> V1 = Vext;

<a name="line948">948: </a>  <font color="#B22222">/* Compute matrices V1^* A_i V1 */</font>
<a name="line949">949: </a>  <a href="../../../docs/manualpages/BV/BVSetActiveColumns.html#BVSetActiveColumns">BVSetActiveColumns</a>(V1,j0,j1);
<a name="line950">950: </a>  <font color="#4169E1">for</font> (k=0;k&lt;nep-&gt;nt;k++) {
<a name="line951">951: </a>    <a href="../../../docs/manualpages/DS/DSGetMat.html#DSGetMat">DSGetMat</a>(ds,DSMatExtra[k],&amp;G);
<a name="line952">952: </a>    <a href="../../../docs/manualpages/BV/BVMatProject.html#BVMatProject">BVMatProject</a>(V1,nep-&gt;A[k],V1,G);
<a name="line953">953: </a>    <a href="../../../docs/manualpages/DS/DSRestoreMat.html#DSRestoreMat">DSRestoreMat</a>(ds,DSMatExtra[k],&amp;G);
<a name="line954">954: </a>  }

<a name="line956">956: </a>  <font color="#4169E1">if</font> (extop-&gt;n) {
<a name="line957">957: </a>    <font color="#4169E1">if</font> (extop-&gt;szd) {
<a name="line958">958: </a>      <font color="#B22222">/* Compute matrices V1^* A_i X  and V1^* X */</font>
<a name="line959">959: </a>      <a href="../../../docs/manualpages/BV/BVSetActiveColumns.html#BVSetActiveColumns">BVSetActiveColumns</a>(extop-&gt;W,0,n);
<a name="line960">960: </a>      <font color="#4169E1">for</font> (k=0;k&lt;nep-&gt;nt;k++) {
<a name="line961">961: </a>        <a href="../../../docs/manualpages/BV/BVMatMult.html#BVMatMult">BVMatMult</a>(extop-&gt;X,nep-&gt;A[k],extop-&gt;W);
<a name="line962">962: </a>        <a href="../../../docs/manualpages/BV/BVDot.html#BVDot">BVDot</a>(extop-&gt;W,V1,proj-&gt;V1pApX[k]);
<a name="line963">963: </a>      }
<a name="line964">964: </a>      <a href="../../../docs/manualpages/BV/BVDot.html#BVDot">BVDot</a>(V1,extop-&gt;X,proj-&gt;XpV1);
<a name="line965">965: </a>    }
<a name="line966">966: </a>  }
<a name="line967">967: </a>  <font color="#4169E1">return</font>(0);
<a name="line968">968: </a>}

</pre>
</body>

</html>
