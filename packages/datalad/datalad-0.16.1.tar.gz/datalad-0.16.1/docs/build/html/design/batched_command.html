<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BatchedCommand and BatchedAnnex &mdash; DataLad 0.15.3+529.gc81453444.dirty documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Standard parameters" href="standard_parameters.html" />
    <link rel="prev" title="Threaded runner" href="threaded_runner.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> DataLad
            <img src="../_static/datalad_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.15
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../background.html">Background and motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../related.html">Delineation from related solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics.html">Basic principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credentials.html">Credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../customization.html">Customization and extension of functionality</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="application_vs_library_mode.html">Application-type vs. library-type usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="file_url_handling.html">File URL handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="result_records.html">Result records</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataset_argument.html"><code class="docutils literal notranslate"><span class="pre">dataset</span></code> argument</a></li>
<li class="toctree-l2"><a class="reference internal" href="log_levels.html">Log levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="drop.html">Drop dataset components</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_imports.html">Python import statements</a></li>
<li class="toctree-l2"><a class="reference internal" href="miscpatterns.html">Miscellaneous patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="exception_handling.html">Exception handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="credentials.html">Credential management</a></li>
<li class="toctree-l2"><a class="reference internal" href="url_substitution.html">URL substitution</a></li>
<li class="toctree-l2"><a class="reference internal" href="threaded_runner.html">Threaded runner</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">BatchedCommand and BatchedAnnex</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#batched-command">Batched Command</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#implementation-details">Implementation details</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#batchedannex">BatchedAnnex</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="standard_parameters.html">Standard parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="pos_vs_kw_parameters.html">Positional vs Keyword parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="docstrings.html">Docstrings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cmdline.html">Command line reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modref.html">Python module reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config.html">Configuration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DataLad</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Design</a> &raquo;</li>
      <li>BatchedCommand and BatchedAnnex</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="batchedcommand-and-batchedannex">
<span id="chap-design-batched-command"></span><h1>BatchedCommand and BatchedAnnex<a class="headerlink" href="#batchedcommand-and-batchedannex" title="Permalink to this headline"></a></h1>
<div class="topic">
<p class="topic-title">Specification scope and status</p>
<p>This specification describes the new implementation of <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> and
<code class="docutils literal notranslate"><span class="pre">BatchedAnnex</span></code> in <code class="docutils literal notranslate"><span class="pre">datalad</span></code>.</p>
</div>
<section id="batched-command">
<h2>Batched Command<a class="headerlink" href="#batched-command" title="Permalink to this headline"></a></h2>
<p>The class <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> (in <code class="docutils literal notranslate"><span class="pre">datalad.cmd</span></code>), holds an instance of a running subprocess, allows to send requests to the subprocess over its stdin, and to receive responses from the subprocess over its stdout.</p>
<p>Requests can be provided to an instance of <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> by passing a single request or a list of requests to <code class="docutils literal notranslate"><span class="pre">BatchCommand.__call__()</span></code>, i.e. by applying the function call-operator to an instance of <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code>. A request is either a string or a tuple of strings. In the latter case, the elements of the tuple will be joined by <code class="docutils literal notranslate"><span class="pre">&quot;</span> <span class="pre">&quot;</span></code>. More than one request can be given by providing a list of requests, i.e. a list of strings or tuples. In this case, the return value will be a list with one response for every request.</p>
<p><code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> will send each request that is sent to the subprocess as a single line, after terminating the line by <code class="docutils literal notranslate"><span class="pre">&quot;\n&quot;</span></code>. After the request is sent, <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> calls an output-handler with stdout-ish (an object that provides a <code class="docutils literal notranslate"><span class="pre">readline()</span></code>-function which operates on the stdout of the subprocess) of the subprocess as argument. The output-handler can be provided to the constructor. If no output-handler is provided, a default output-handler is used. The default output-handler reads a single output line on stdout, using <code class="docutils literal notranslate"><span class="pre">io.IOBase.readline()</span></code>, and returns the <code class="docutils literal notranslate"><span class="pre">rstrip()</span></code>-ed line.</p>
<p>The subprocess must at least emit one line of output per line of input in order to prevent the calling thread from blocking. In addition, the size of the output, i.e. the number of lines that the result consists of, must be discernible by the output-handler. That means, the subprocess must either return a fixed number of lines per input line, or it must indicate the end of a result in some other way, e.g. with an empty line.</p>
<p>Remark: In principle any output processing could be performed. But, if the output-handler blocks on stdout, the calling thread will be blocked. Due to the limited capabilities of the stdout-ish that is passed to the output-handler, the output-handler must rely on <code class="docutils literal notranslate"><span class="pre">readline()</span></code> to process the output of the subprocess. Together with the line-based request sending, <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> is geared towards supporting the batch processing modes of <code class="docutils literal notranslate"><span class="pre">git</span></code> and <code class="docutils literal notranslate"><span class="pre">git-annex</span></code>. <em>This has to be taken into account when providing a custom output handler.</em></p>
<p>When <code class="docutils literal notranslate"><span class="pre">BatchedCommand.close()</span></code> is called, stdin, stdout, and stderr of the subprocess are closed. This indicates the end of processing to the subprocess. Generally the subprocess is expected to exit shortly after that. <code class="docutils literal notranslate"><span class="pre">BatchedCommand.close()</span></code> will wait for the subprocess to end, if the configuration <code class="docutils literal notranslate"><span class="pre">datalad.runtime.stalled-external</span></code> is set to <code class="docutils literal notranslate"><span class="pre">&quot;wait&quot;</span></code>. If the configuration <code class="docutils literal notranslate"><span class="pre">datalad.runtime.stalled-external</span></code> is set to <code class="docutils literal notranslate"><span class="pre">&quot;abandon&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">BatchedCommand.close()</span></code> will return after “timeout” seconds if <code class="docutils literal notranslate"><span class="pre">timeout</span></code> was provided to <code class="docutils literal notranslate"><span class="pre">BatchedCommand.__init__()</span></code>, otherwise it will return after 11 seconds. If a timeout occurred, the attribute <code class="docutils literal notranslate"><span class="pre">wait_timed_out</span></code> of the <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> instance will be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>. If <code class="docutils literal notranslate"><span class="pre">exception_on_timeout=True</span></code> is provided to <code class="docutils literal notranslate"><span class="pre">BatchedCommand.__init__()</span></code>, a <code class="docutils literal notranslate"><span class="pre">subprocess.TimeoutExpired</span></code> exception will be raised on a timeout while waiting for the process. It is not safe to reused a <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> instance after such an exception was risen.</p>
<p>Stderr of the subprocess is gathered in a byte-string. Its content will be returned by <code class="docutils literal notranslate"><span class="pre">BatchCommand.close()</span></code> if the parameter <code class="docutils literal notranslate"><span class="pre">return_stderr</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<section id="implementation-details">
<h3>Implementation details<a class="headerlink" href="#implementation-details" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> uses <code class="docutils literal notranslate"><span class="pre">WitlessRunner</span></code> with a protocol that has <code class="docutils literal notranslate"><span class="pre">datalad.runner.protocol.GeneratorMixIn</span></code> as a super-class. The protocol uses an output-handler to process data, if an output-handler was specified during construction of <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">BatchedCommand.close()</span></code> queries the configuration key <code class="docutils literal notranslate"><span class="pre">datalad.runtime.stalled-external</span></code> to determine how to handle non-exiting processes (there is no killing, processes or process zombies might just linger around until the next reboot).</p>
<p>The current implementation of <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> can process a list of multiple requests at once, but it will collect all answers before returning a result. That means, if you send 1000 requests, <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> will return after having received 1000 responses.</p>
</section>
</section>
<section id="batchedannex">
<h2>BatchedAnnex<a class="headerlink" href="#batchedannex" title="Permalink to this headline"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">BatchedAnnex</span></code> is a subclass of <code class="docutils literal notranslate"><span class="pre">BatchedCommand</span></code> (which it actually doesn’t have to be, it just adds git-annex specific parameters to the command and sets a specific output handler).</p>
<p><code class="docutils literal notranslate"><span class="pre">BatchedAnnex</span></code> provides a new output-handler if the constructor-argument <code class="docutils literal notranslate"><span class="pre">json</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code>. In this case, an output handler is used that reads a single line from stdout, strips the line and converts it into a json object, which is returned. If the stripped line is empty, an empty dictionary is returned.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="threaded_runner.html" class="btn btn-neutral float-left" title="Threaded runner" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="standard_parameters.html" class="btn btn-neutral float-right" title="Standard parameters" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, DataLad team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>