<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Threaded runner &mdash; DataLad 0.15.3+529.gc81453444.dirty documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BatchedCommand and BatchedAnnex" href="batched_command.html" />
    <link rel="prev" title="URL substitution" href="url_substitution.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> DataLad
            <img src="../_static/datalad_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.15
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Change log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../publications.html">Publications</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../background.html">Background and motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../related.html">Delineation from related solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics.html">Basic principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../credentials.html">Credentials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../metadata.html">Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../customization.html">Customization and extension of functionality</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="application_vs_library_mode.html">Application-type vs. library-type usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="file_url_handling.html">File URL handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="result_records.html">Result records</a></li>
<li class="toctree-l2"><a class="reference internal" href="dataset_argument.html"><code class="docutils literal notranslate"><span class="pre">dataset</span></code> argument</a></li>
<li class="toctree-l2"><a class="reference internal" href="log_levels.html">Log levels</a></li>
<li class="toctree-l2"><a class="reference internal" href="drop.html">Drop dataset components</a></li>
<li class="toctree-l2"><a class="reference internal" href="python_imports.html">Python import statements</a></li>
<li class="toctree-l2"><a class="reference internal" href="miscpatterns.html">Miscellaneous patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="exception_handling.html">Exception handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="credentials.html">Credential management</a></li>
<li class="toctree-l2"><a class="reference internal" href="url_substitution.html">URL substitution</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Threaded runner</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#threads">Threads</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#transport-threads">Transport Threads</a></li>
<li class="toctree-l4"><a class="reference internal" href="#process-waiting-thread">Process Waiting Thread</a></li>
<li class="toctree-l4"><a class="reference internal" href="#main-thread">Main Thread</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#protocols">Protocols</a></li>
<li class="toctree-l3"><a class="reference internal" href="#object-and-generator-results">Object and Generator Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="batched_command.html">BatchedCommand and BatchedAnnex</a></li>
<li class="toctree-l2"><a class="reference internal" href="standard_parameters.html">Standard parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="pos_vs_kw_parameters.html">Positional vs Keyword parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="docstrings.html">Docstrings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../cmdline.html">Command line reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modref.html">Python module reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config.html">Configuration</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DataLad</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Design</a> &raquo;</li>
      <li>Threaded runner</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="threaded-runner">
<span id="chap-threaded-runner"></span><h1>Threaded runner<a class="headerlink" href="#threaded-runner" title="Permalink to this headline"></a></h1>
<div class="topic">
<p class="topic-title">Specification scope and status</p>
<p>This specification provides an overview over the current implementation of the subprocess runner that is used throughout datalad.</p>
</div>
<section id="threads">
<h2>Threads<a class="headerlink" href="#threads" title="Permalink to this headline"></a></h2>
<p>Datalad often requires the execution of subprocesses. While subprocesses are executed, datalad, i.e. its main thread, should be able to read data from stdout and stderr of the subprocess as well as write data to stdin of the subprocess. This requires a way to efficiently multiplex reading from stdout and stderr of the subprocess as well as writing to stdin of the subprocess.</p>
<p>Since non-blocking IO and waiting on multiple sources (poll or select) differs vastly in terms of capabilities and API on different OSs, we decided to use blocking IO and threads to multiplex reading from different sources.</p>
<p>Generally we have a number of threads that might be created and executed, depending on the need for writing to stdin or reading from stdout or stderr. Each thread can read from either a single queue or a file descriptor. Reading is done blocking. Each thread can put data into multiple queues. This is used to transport data that was read as well as for signaling conditions like closed file descriptors.</p>
<p>Conceptually, there are the main thread and two different types of threads:</p>
<blockquote>
<div><ul class="simple">
<li><p>type 1: transport threads (1 thread per process I/O descriptor)</p></li>
<li><p>type 2: process waiting thread (1 thread)</p></li>
</ul>
</div></blockquote>
<section id="transport-threads">
<h3>Transport Threads<a class="headerlink" href="#transport-threads" title="Permalink to this headline"></a></h3>
<p>Besides the main thread, there might be up to three additional threads to handle data transfer to <code class="docutils literal notranslate"><span class="pre">stdin</span></code>, and from <code class="docutils literal notranslate"><span class="pre">stdout</span></code> and <code class="docutils literal notranslate"><span class="pre">stderr</span></code>. Each of those threads copies data between queues and file descriptors in a tight loop. The stdin-thread reads from an input-queue, the stdout- and stderr-threads write to an output queue. Each thread signals its exit to a set of signal queues, which might be identical to the output queues.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">stdin</span></code>-thread reads data from a queue and writes it to the <code class="docutils literal notranslate"><span class="pre">stdin</span></code>-file descriptor of the sub-process. If it reads <code class="docutils literal notranslate"><span class="pre">None</span></code> from the queue, it will exit. The thread will also exit, if an exit is requested by calling <code class="docutils literal notranslate"><span class="pre">thread.request_exit()</span></code>, or if an error occurs during writing. In all cases it will enqueue a <code class="docutils literal notranslate"><span class="pre">None</span></code> to all its signal-queues.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">stdout</span></code>- and <code class="docutils literal notranslate"><span class="pre">stderr</span></code>-threads read from the respective file descriptor and enqueue data into their output queue, unless the data has zero length (which indicates a closed descriptor). On a zero-length read they exit and enqueue <code class="docutils literal notranslate"><span class="pre">None</span></code> into their signal queues.</p>
<p>All queues are infinite. Nevertheless signaling is performed with a timeout of one 100 milliseconds in order to ensure that threads can exit.</p>
</section>
<section id="process-waiting-thread">
<h3>Process Waiting Thread<a class="headerlink" href="#process-waiting-thread" title="Permalink to this headline"></a></h3>
<p>The process waiting thread waits for a given process to exit and enqueues an exit notification into it signal queues.</p>
</section>
<section id="main-thread">
<h3>Main Thread<a class="headerlink" href="#main-thread" title="Permalink to this headline"></a></h3>
<p>There is a single queue, the <code class="docutils literal notranslate"><span class="pre">output_queue</span></code>, on which the main thread waits, after all transport threads, and the process waiting thread are started. The <code class="docutils literal notranslate"><span class="pre">output_queue</span></code> is the signaling queue and the output queue of the stderr-thread and the stdout-thread. It is also the signaling queue of the stdin-thread, and it is the signaling queue for the process waiting threads.</p>
<p>The main thread waits on the <code class="docutils literal notranslate"><span class="pre">output_queue</span></code> for data or signals and handles them accordingly, i.e. calls data callbacks of the protocol if data arrives, and calls connection-related callbacks of the protocol if other signals arrive. If no messages arrive on the  <code class="docutils literal notranslate"><span class="pre">output_queue</span></code>, the main thread blocks for 100ms. If it is unblocked, either by getting a message or due to elapsing of the 100ms, it will process timeouts. If the <code class="docutils literal notranslate"><span class="pre">timeout</span></code>-parameter to the constructor was not <code class="docutils literal notranslate"><span class="pre">None</span></code>, it will check the last time any of the monitored files (stdout and/or stderr) yielded data. If the time is larger than the specified timeout, it will call the <code class="docutils literal notranslate"><span class="pre">tiemout</span></code> method of the protocol instance. Due to this implementation, the resolution for timeouts is 100ms. The main thread handles the closing of <code class="docutils literal notranslate"><span class="pre">stdin</span></code>-, <code class="docutils literal notranslate"><span class="pre">stdout</span></code>-, and <code class="docutils literal notranslate"><span class="pre">stderr</span></code>-file descriptors if all other threads have terminated and if <code class="docutils literal notranslate"><span class="pre">output_queue</span></code> is empty. These tasks are either performed in the method <code class="docutils literal notranslate"><span class="pre">ThreadedRunner.run()</span></code> or in a result generator that is returned by  <code class="docutils literal notranslate"><span class="pre">ThreadedRunner.run()</span></code> whenever <code class="docutils literal notranslate"><span class="pre">send()</span></code> is called on it.</p>
</section>
</section>
<section id="protocols">
<h2>Protocols<a class="headerlink" href="#protocols" title="Permalink to this headline"></a></h2>
<p>Due to its history the runner implementation uses the interface defined in <code class="docutils literal notranslate"><span class="pre">SubprocessProtocol</span></code> (asyncio.protocols.SubprocessProtocol) (although the sub process protocol interface is defined in the asyncio libraries, the current thread-runner implementation does not make use of <code class="docutils literal notranslate"><span class="pre">async</span></code>).</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SubprocessProtocol.pipe_data_received(fd,</span> <span class="pre">data)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SubprocessProtocol.pipe_connection_lost(fd,</span> <span class="pre">exc)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SubprocessProtocol.process_exited()</span></code></p></li>
</ul>
</div></blockquote>
<p>In addition the methods of <code class="docutils literal notranslate"><span class="pre">BaseProtocol</span></code> are called, i.e.:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">BaseProtocol.connection_made(transport)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">BaseProtocol.connection_lost(exc)</span></code></p></li>
</ul>
</div></blockquote>
<p>The datalad-provided protocol <code class="docutils literal notranslate"><span class="pre">WitlessProtocol</span></code> provides an additional callback:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">WitlessProtocol.timeout(fd)</span></code></p></li>
</ul>
</div></blockquote>
<p>The method <code class="docutils literal notranslate"><span class="pre">timeout()</span></code> will be called when the parameter <code class="docutils literal notranslate"><span class="pre">timeout</span></code> in <code class="docutils literal notranslate"><span class="pre">WitlessRunner.run</span></code>, <code class="docutils literal notranslate"><span class="pre">ThreadedRunner.run</span></code>, or <code class="docutils literal notranslate"><span class="pre">run_command</span></code> is set to a number specifying the desired timeout in seconds. If no data is received from <code class="docutils literal notranslate"><span class="pre">stdin</span></code>, or <code class="docutils literal notranslate"><span class="pre">stderr</span></code> (if those are supposed to be captured), the method <code class="docutils literal notranslate"><span class="pre">WitlessProtocol.timeout(fd)</span></code> is called with <code class="docutils literal notranslate"><span class="pre">fd</span></code> set to the respective file number, e.g. 1, or 2. If <code class="docutils literal notranslate"><span class="pre">WitlessProtocol.timeout(fd)</span></code> returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, the file descriptor will be closed and the associated threads will exit.</p>
<p>The method <code class="docutils literal notranslate"><span class="pre">WitlessProtocol.timeout(fd)</span></code> is also called if stdout, stderr and stdin are closed and the process does not exit within the given interval. In this case <code class="docutils literal notranslate"><span class="pre">fd</span></code> is set to <code class="docutils literal notranslate"><span class="pre">None</span></code>. If <code class="docutils literal notranslate"><span class="pre">WitlessProtocol.timeout(fd)</span></code> returns <code class="docutils literal notranslate"><span class="pre">True</span></code> the process is terminated.</p>
</section>
<section id="object-and-generator-results">
<h2>Object and Generator Results<a class="headerlink" href="#object-and-generator-results" title="Permalink to this headline"></a></h2>
<p>If the protocol that is provided to <code class="docutils literal notranslate"><span class="pre">run()</span></code> does not inherit <code class="docutils literal notranslate"><span class="pre">datalad.runner.protocol.GeneratorMixIn</span></code>, the final result that will be returned to the caller is determined by calling <code class="docutils literal notranslate"><span class="pre">WitlessProtocol._prepare_result()</span></code>. Whatever object this method returns will be returned to the caller.</p>
<p>If the protocol that is provided to <code class="docutils literal notranslate"><span class="pre">run()</span></code> does inherit <code class="docutils literal notranslate"><span class="pre">datalad.runner.protocol.GeneratorMixIn</span></code>, <code class="docutils literal notranslate"><span class="pre">run()</span></code> will return a <code class="docutils literal notranslate"><span class="pre">Generator</span></code>. This generator will yield the elements that were sent to it in the protocol-implementation by calling <code class="docutils literal notranslate"><span class="pre">GeneratorMixIn.send_result()</span></code> in the order in which the method <code class="docutils literal notranslate"><span class="pre">GeneratorMixIn.send_result()</span></code> is called. For example, if <code class="docutils literal notranslate"><span class="pre">GeneratorMixIn.send_result(43)</span></code> is called, the generator will yield <code class="docutils literal notranslate"><span class="pre">43</span></code>, and if <code class="docutils literal notranslate"><span class="pre">GeneratorMixIn.send_result({&quot;a&quot;:</span> <span class="pre">123,</span> <span class="pre">&quot;b&quot;:</span> <span class="pre">&quot;some</span> <span class="pre">data&quot;})</span></code> is called, the generator will yield <code class="docutils literal notranslate"><span class="pre">{&quot;a&quot;:</span> <span class="pre">123,</span> <span class="pre">&quot;b&quot;:</span> <span class="pre">&quot;some</span> <span class="pre">data&quot;}</span></code>.</p>
<p>Internally the generator is implemented by keeping track of the process state and waiting in the <code class="docutils literal notranslate"><span class="pre">output_queue</span></code> once, when <code class="docutils literal notranslate"><span class="pre">send</span></code> is called on it.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="url_substitution.html" class="btn btn-neutral float-left" title="URL substitution" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="batched_command.html" class="btn btn-neutral float-right" title="BatchedCommand and BatchedAnnex" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2022, DataLad team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>