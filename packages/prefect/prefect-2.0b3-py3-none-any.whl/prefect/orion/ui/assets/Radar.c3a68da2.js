var G=Object.defineProperty;var Q=(o,s,t)=>s in o?G(o,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[s]=t;var M=(o,s,t)=>(Q(o,typeof s!="symbol"?s+"":s,t),t);import{_ as U,d as J,c as z,e as N,L as q,Z as K,av as tt,o as B,h as W,p as Y,at as st,j as et,H as it,W as nt,aw as ot,aj as at,z as rt,A as dt}from"./index.af9a7d5e.js";const L=Math.PI,S=2*L,I=1e-6,ht=S-I;function T(){this._x0=this._y0=this._x1=this._y1=null,this._=""}function D(){return new T}T.prototype=D.prototype={constructor:T,moveTo:function(o,s){this._+="M"+(this._x0=this._x1=+o)+","+(this._y0=this._y1=+s)},closePath:function(){this._x1!==null&&(this._x1=this._x0,this._y1=this._y0,this._+="Z")},lineTo:function(o,s){this._+="L"+(this._x1=+o)+","+(this._y1=+s)},quadraticCurveTo:function(o,s,t,e){this._+="Q"+ +o+","+ +s+","+(this._x1=+t)+","+(this._y1=+e)},bezierCurveTo:function(o,s,t,e,i,a){this._+="C"+ +o+","+ +s+","+ +t+","+ +e+","+(this._x1=+i)+","+(this._y1=+a)},arcTo:function(o,s,t,e,i){o=+o,s=+s,t=+t,e=+e,i=+i;var a=this._x1,n=this._y1,r=t-o,d=e-s,l=a-o,p=n-s,h=l*l+p*p;if(i<0)throw new Error("negative radius: "+i);if(this._x1===null)this._+="M"+(this._x1=o)+","+(this._y1=s);else if(h>I)if(!(Math.abs(p*r-d*l)>I)||!i)this._+="L"+(this._x1=o)+","+(this._y1=s);else{var y=t-a,g=e-n,v=r*r+d*d,m=y*y+g*g,w=Math.sqrt(v),R=Math.sqrt(h),k=i*Math.tan((L-Math.acos((v+h-m)/(2*w*R)))/2),b=k/R,$=k/w;Math.abs(b-1)>I&&(this._+="L"+(o+b*l)+","+(s+b*p)),this._+="A"+i+","+i+",0,0,"+ +(p*y>l*g)+","+(this._x1=o+$*r)+","+(this._y1=s+$*d)}},arc:function(o,s,t,e,i,a){o=+o,s=+s,t=+t,a=!!a;var n=t*Math.cos(e),r=t*Math.sin(e),d=o+n,l=s+r,p=1^a,h=a?e-i:i-e;if(t<0)throw new Error("negative radius: "+t);this._x1===null?this._+="M"+d+","+l:(Math.abs(this._x1-d)>I||Math.abs(this._y1-l)>I)&&(this._+="L"+d+","+l),t&&(h<0&&(h=h%S+S),h>ht?this._+="A"+t+","+t+",0,1,"+p+","+(o-n)+","+(s-r)+"A"+t+","+t+",0,1,"+p+","+(this._x1=d)+","+(this._y1=l):h>I&&(this._+="A"+t+","+t+",0,"+ +(h>=L)+","+p+","+(this._x1=o+t*Math.cos(i))+","+(this._y1=s+t*Math.sin(i))))},rect:function(o,s,t,e){this._+="M"+(this._x0=this._x1=+o)+","+(this._y0=this._y1=+s)+"h"+ +t+"v"+ +e+"h"+-t+"Z"},toString:function(){return this._}};const{cos:V}=Math,{max:H}=Math,{sin:C}=Math,{sqrt:Z}=Math,{pow:wt}=Math,{floor:O}=Math,{ceil:ct}=Math,_=Math.PI,A=o=>o**2,X=o=>{const s=o.radius,t=100,e=100,i=D();return i.arc(t,e,s,o.start,o.end,!1),i.toString()},lt=([,o],s)=>{var l,p,h,y,g;const t=[],e=o.radius,a=125*360/(2*_*e||10),n=(90-a)*_/180,r=(90+a)*_/180;let d=((l=o.positions.get(o.positions.size-1))==null?void 0:l.radian)||0;for(const[,v]of o.positions){const m=[...v.nodes.values()],w=(g=(y=(h=(p=m==null?void 0:m[0])==null?void 0:p.data)==null?void 0:h.state)==null?void 0:y.type)==null?void 0:g.toLowerCase();e==0?t.push({start:115*_/180,end:65*_/180,radius:s/4,state:w||null}):v.radian>n&&d<r?(t.push({start:d,end:n,radius:e,state:null}),t.push({start:r,end:v.radian,radius:e,state:w||null})):t.push({start:d,end:v.radian,radius:e,state:w||null}),d=v.radian}return t};const ut=o=>(rt("data-v-07d676a7"),o=o(),dt(),o),pt=ut(()=>Y("g",{class:"mini-radar__ring-container"},null,-1)),gt=[pt],ft=J({props:{radar:null,collapsedTrees:null,transform:{default:()=>({x:0,y:0,k:1})},height:null,width:null,id:null,baseRadius:{default:300},disableInteractions:{type:Boolean,default:!1},hideViewport:{type:Boolean,default:!1}},emits:["drag-viewport","pan-to-location"],setup(o,{emit:s}){const t=o,e=z(),i=z(),a=z(),n=z(),r=z(0),d=z(0),l=z(!1),p=N(()=>{var u;const f=[...((u=t.collapsedTrees)==null?void 0:u.entries())||new Map().entries()];return new Map([...t.radar.nodes.entries()].filter(([,c])=>f.every(([,x])=>!x.get(c.id))).filter(([,c])=>{var j;if(!t.radar.rings.get(c.ring))return;const{position:E}=c;if(!E)return;const P=[...E.nodes.values()];return((j=P==null?void 0:P[0])==null?void 0:j.id)==c.id}))}),h=N(()=>{const f=new Set([...p.value.entries()].map(([,u])=>u.ring));return new Map([...t.radar.rings.entries()].filter(([u])=>f.has(u)))}),y=N(()=>{const f=[...h.value.entries()].map(([,u])=>u.radius);return Math.max(...f,t.baseRadius*2)}),g=N(()=>Math.min(d.value,r.value)/(y.value*2.5)),v=N(()=>({height:`${m.value.height}px`,width:`${m.value.width}px`})),m=N(()=>!t.height||!t.width?{height:0,width:0}:{height:t.height*g.value,width:t.width*g.value}),w=()=>{var u;const f=c=>`radar__arc-segment ${c.state?`${c.state}-stroke`:""}`;(u=n.value)==null||u.style("transform",`scale(${g.value})`).selectAll(".radar__arc-segment-group").data(h.value).join(c=>c.append("g").attr("class","radar__arc-segment-group"),c=>c,c=>c.remove()).selectAll(".radar__arc-segment").data(c=>lt(c,t.baseRadius)).join(c=>c.append("path").attr("class",f).attr("fill","transparent").attr("stroke","rgba(0, 0, 0, 0.1)").attr("stroke-width",80).attr("d",x=>X(x)),c=>c.attr("class",f).attr("d",x=>X(x)),c=>c.remove())},R=f=>{if(!l.value||t.disableInteractions)return;const u=f.movementX*-(1/g.value),c=f.movementY*-(1/g.value);s("drag-viewport",{x:u,y:c})},k=f=>{var P;if(t.disableInteractions)return;const u=(P=f.target)==null?void 0:P.getBoundingClientRect(),c=(f.clientX-u.left-100)/g.value,x=(f.clientY-u.top-100)/g.value,E=ot.scale(t.transform.k).translate(-c,-x);s("pan-to-location",E)},b=()=>{var c;if(!e.value)return;const f=e.value.offsetWidth,u=e.value.offsetHeight;d.value=f,r.value=u,(c=a.value)==null||c.attr("viewbox","0, 0, 200, 200").attr("width",f).attr("height",u),w()};q(()=>t.transform,()=>{if(i.value){const f=(1-t.transform.x/t.transform.k)*g.value+100-m.value.width/2,u=(1-t.transform.y/t.transform.k)*g.value+100-m.value.height/2;i.value.style.transform=`translate(${f}px, ${u}px) scale(${1/t.transform.k})`,i.value.style.borderRadius=`${Math.max(4*t.transform.k,4)}px`}}),q(h,()=>requestAnimationFrame(()=>w()));const $=()=>{a.value=at(".mini-radar__canvas"),n.value=a.value.select(".mini-radar__ring-container"),n.value.style("transform",`scale(${g.value})`),b(),w()};return K(()=>{$(),window.addEventListener("resize",b)}),tt(()=>{window.removeEventListener("resize",b)}),(f,u)=>(B(),W("div",{ref_key:"container",ref:e,class:nt(["mini-radar position-relative",{"mini-radar--disabled":t.disableInteractions}]),onMousemove:R,onMouseleave:u[2]||(u[2]=c=>l.value=!1)},[Y("svg",{class:"mini-radar__canvas",onClick:k},gt),o.hideViewport?it("",!0):(B(),W("div",{key:0,ref_key:"viewport",ref:i,class:"mini-radar__viewport position-absolute",style:st(et(v)),onMousedown:u[0]||(u[0]=c=>l.value=!0),onMouseup:u[1]||(u[1]=c=>l.value=!1)},null,36))],34))}});var Mt=U(ft,[["__scopeId","data-v-07d676a7"]]);function F(o){return Array.from(o).filter(([,s])=>s.nodes.size==0)}function _t(o){var t;return(t=F(o)[0])==null?void 0:t[0]}class yt{constructor(){M(this,"_id","id");M(this,"_dependencies","upstream_ids");M(this,"nodes",new Map);M(this,"positions",new Map);M(this,"links",[]);M(this,"rings",new Map);M(this,"expandedRings",[]);M(this,"baseRadius",500);M(this,"channelWidth",250);M(this,"width",275);M(this,"height",145);M(this,"cx",0);M(this,"cy",0);return this}center([s,t]){return this.cx=s,this.cy=t,this}expandRing(s){if(!this.rings.get(s))throw new Error("Invalid ringId when expanding ring.");if(this.expandedRings.includes(s))throw new Error("Attempted to expand an already expanded ring.");return this.expandedRings.push(s),this.computeRings(),this.computeInitialPositions(),this}collapseRing(s){if(!this.rings.get(s))throw new Error("Invalid ringId when collapsing ring.");const e=this.expandedRings.indexOf(s);if(e==-1)throw new Error("Attempted to collapse an already collapsed ring.");return this.expandedRings.splice(e,1),this.computeRings(),this.computeInitialPositions(),this}id(s){return this._id=s,this}dependencies(s){return this._dependencies=s,this}items(s){return this.update(s),this}traverse(s,t){if(!s)throw new Error("No starting node was provided to the traverse method.");const e=[s];let i;const a=new Map;for(;e.length>0;)if(i=e.shift(),t==null||t(i),!!i.downstreamNodes.size)for(const[n,r]of i.downstreamNodes)e.push(r),a.set(n,i);return a}update(s){this.nodes=new Map,this.rings=new Map,this.links=[],this.computeNodes(s),this.computeLinks(),this.computeNodeRings(),this.computeRings(),this.computeInitialPositions()}computeNodes(s){const t=s.length;for(let e=0;e<t;e++){const i=s[e],a=this.nodes.get(i[this._id]);a?this.nodes.set(i[this._id],{id:i[this._id],cx:a.cx,cy:a.cy,radian:a.radian,data:i,downstreamNodes:new Map,upstreamNodes:new Map,ring:a.ring}):this.nodes.set(i[this._id],{id:i[this._id],cx:0,cy:0,radian:0,data:i,downstreamNodes:new Map,upstreamNodes:new Map,ring:0})}}computeNodeRings(){const s=[...this.rings.entries()];for(const[t,e]of this.nodes){const i=this.distance(e,"up");e.ring=i,this.nodes.set(t,e),s[i]?s[i][1].nodes.set(t,e):s[i]=[i,{radius:0,nodes:new Map([[t,e]]),positions:new Map,links:[]}]}this.rings=new Map(s)}computeLinks(){for(const[s,t]of this.nodes){const e=t.data[this._dependencies],i=e.length;for(let a=0;a<i;a++){const n=this.nodes.get(e[a][this._id]),r={target:t,source:n};t.upstreamNodes.set(e[a][this._id],n),n.downstreamNodes.set(s,t),this.nodes.set(e[a][this._id],n),this.nodes.set(s,t),this.links.push(r)}}}distance(s,t){const e=t=="up"?"upstreamNodes":t=="down"?"downstreamNodes":void 0;if(e==null)throw new Error("Direction wasn't provided; accepted values: 'up' or 'down'.");const i=(a,n=0)=>{if(a[e].size>0){const r=[];n=n+1;for(const[,d]of a[e]){const l=i(d,n);r.push(l)}return H(...r)}return n};return i(s)}computeRings(s=0){var e;const t=[...this.rings.entries()];for(let i=s;i<t.length;i++){const a=t[0][1].nodes.size,{size:n}=t[i][1].nodes,r=(e=t[i-1])==null?void 0:e[1];let d;if(r?d=r.radius+this.baseRadius:d=a===1?i*this.baseRadius:(i+1)*this.baseRadius,this.expandedRings.includes(i)&&n>1){const p=Z(A(this.height)+A(this.width));d=H(ct(n*p/(_*2)),d)}const l=this.computeRingPositions(d);t[i][1].radius=d,t[i][1].positions=l;for(let p=0;p<l.size;p++){const h=l.get(p);!h||this.positions.set(h.id,h)}}this.rings=new Map(t),this.links.forEach(i=>{const a=this.rings.get(i.source.ring);a&&(a.links.push(i),this.rings.set(i.source.ring,a))})}computeInitialPositions(){if(this.rings.size===0)return;let s;for(const[t,e]of this.rings){let i=0;for(const[a,n]of e.nodes){const r=this.getNodePosition(n,t,s,i);n.cx=this.cx+e.radius*V(r.radian),n.cy=this.cy+e.radius*C(r.radian),n.radian=r.radian,n.position=r,r.nodes.set(n.id,n),e.positions.set(r.id,r),this.rings.set(t,e),this.nodes.set(a,n),++i}s=e}this.nodes=new Map([...this.nodes].sort(([,t],[,e])=>!t.position||!e.position?0:t.ring==e.ring?t.position.id-e.position.id:t.ring-e.ring))}computeRingPositions(s){const t=new Map;if(s<=0)return t.set(0,{id:0,radian:0,nodes:new Map,radius:s}),t;let e=0,i=0;const a=[0],n=_/2-this.width*.8/2/s;for(;e<n;){const r=1.25-.3*C(e),d=Z(A(this.height)*A(V(i))+A(this.width)*A(C(i))),l=r*d/s;i+=l,e+=l,e<n&&(e<s/(this.channelWidth+this.width/2)&&(a.push(e%(2*_)),a.push((3*_-e)%(2*_))),a.push((_+e)%(2*_)),a.push((2*_-e)%(2*_)))}return a.push(_),a.sort().forEach((r,d)=>t.set(d,{id:d,radian:r,nodes:new Map,radius:s})),t}getNodePosition(s,t,e,i=0){var l,p;const n=this.rings.get(t).positions;let r;if([...n.values()].every(h=>h.nodes.size>0))return n.get(n.size-1);if(s.upstreamNodes.size===0||t==0||t==1){const h=F(n);i===0||i%2===0?r=n.get((l=h[0])==null?void 0:l[0]):r=n.get((p=h[O(h.length/2)])==null?void 0:p[0])}else{const h=s.upstreamNodes.entries();for(;!r;){const[,y]=h.next().value||[null,null];if(!y)break;const g=O(y.position/e.positions.size*n.size),v=n.get(g);if(v&&v.nodes.size===0){r=v;break}let m=g-1==0?n.size-1:g-1,w=g+1;for(;m>=0||w<=n.size;){const R=n.get(m);if(R&&R.nodes.size===0){r=R;break}const k=n.get(w);if(k&&k.nodes.size===0){r=k;break}m--,w++}}}if(!r){const h=_t(n);r=typeof h!="undefined"?n.get(h):n.get(n.size-1)}return r}}export{Mt as M,yt as R,D as a,_ as b,V as c,C as d,wt as p,Z as s};
